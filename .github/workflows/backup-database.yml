name: Database Backup

on:
  schedule:
    # Daily at 3am UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Install PostgreSQL 17 client
        run: |
          # Add PostgreSQL APT repository for version 17
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Create backup
        env:
          # Use direct connection, not pooler (pg_dump doesn't work with pooler)
          DATABASE_URL: ${{ secrets.DATABASE_URL_DIRECT }}
        run: |
          # Create backup with pg_dump (use full path to PG17 version)
          /usr/lib/postgresql/17/bin/pg_dump "$DATABASE_URL" \
            --no-owner \
            --no-acl \
            --format=plain \
            --file=backup.sql

          # Compress the backup
          gzip backup.sql

          # Show backup size
          ls -lh backup.sql.gz
          echo "Backup created successfully"

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}-${{ github.run_number }}
          path: backup.sql.gz
          retention-days: 90
          if-no-files-found: error

      - name: Notify on failure
        if: failure()
        run: |
          curl -s -X POST "https://ntfy.sh/property-tracker-claude" \
            -d "Database backup FAILED! Check GitHub Actions: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -H "Title: BrickTrack Backup Failed" \
            -H "Priority: urgent" \
            -H "Tags: warning"
