"use client";

import { useRouter } from "next/navigation";

import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";

interface Property {
  id: string;
  address: string;
  suburb: string;
  state: string;
  postcode: string;
  latitude: string | null;
  longitude: string | null;
}

export interface AustraliaPropertiesMapProps {
  properties: Property[];
}

// Coordinate system: SVG viewBox 0 0 400 340
// Longitude 112E-155E -> x: 20-380
// Latitude 10S-45S -> y: 20-320
const PAD = 20;
const SVG_W = 400;
const SVG_H = 340;
const LON_MIN = 112;
const LON_MAX = 155;
const LAT_MIN = -10; // 10°S (top)
const LAT_MAX = -45; // 45°S (bottom)

function toSvg(lon: number, lat: number): [number, number] {
  const x = PAD + ((lon - LON_MIN) / (LON_MAX - LON_MIN)) * (SVG_W - 2 * PAD);
  const y = PAD + ((lat - LAT_MIN) / (LAT_MAX - LAT_MIN)) * (SVG_H - 2 * PAD);
  return [Math.round(x * 10) / 10, Math.round(y * 10) / 10];
}

// Fallback: state capital coords for properties without lat/lng
const STATE_CENTERS: Record<string, { lon: number; lat: number }> = {
  NSW: { lon: 151.2, lat: -33.9 },
  VIC: { lon: 144.96, lat: -37.81 },
  QLD: { lon: 153.0, lat: -27.5 },
  SA: { lon: 138.6, lat: -34.9 },
  WA: { lon: 115.9, lat: -32.0 },
  TAS: { lon: 147.3, lat: -42.0 },
  NT: { lon: 130.8, lat: -12.5 },
  ACT: { lon: 149.1, lat: -35.3 },
};

function getPropertyCoords(p: Property): { cx: number; cy: number } {
  if (p.latitude && p.longitude) {
    const [cx, cy] = toSvg(parseFloat(p.longitude), parseFloat(p.latitude));
    return { cx, cy };
  }
  // Fallback: use state capital with postcode-based offset
  const center = STATE_CENTERS[p.state] || { lon: 134.0, lat: -25.0 };
  const pc = parseInt(p.postcode, 10);
  const hash = ((pc * 2654435761) >>> 0) % 1000;
  const lonOffset = ((hash % 20) - 10) * 0.15;
  const latOffset = (((hash * 7) % 20) - 10) * 0.1;
  const [cx, cy] = toSvg(center.lon + lonOffset, center.lat + latOffset);
  return { cx, cy };
}

// 786 dots generated from accurate Australia coastline data (8px grid spacing)
// prettier-ignore
const DOTS: [number, number][] = [[40,128],[40,136],[40,144],[40,152],[40,160],[40,168],[40,176],[40,184],[40,192],[48,120],[48,128],[48,136],[48,144],[48,152],[48,160],[48,168],[48,176],[48,184],[48,192],[48,200],[48,208],[48,216],[48,224],[56,120],[56,128],[56,136],[56,144],[56,152],[56,160],[56,168],[56,176],[56,184],[56,192],[56,200],[56,208],[56,216],[56,224],[64,112],[64,120],[64,128],[64,136],[64,144],[64,152],[64,160],[64,168],[64,176],[64,184],[64,192],[64,200],[64,208],[64,216],[64,224],[72,112],[72,120],[72,128],[72,136],[72,144],[72,152],[72,160],[72,168],[72,176],[72,184],[72,192],[72,200],[72,208],[72,216],[72,224],[80,112],[80,120],[80,128],[80,136],[80,144],[80,152],[80,160],[80,168],[80,176],[80,184],[80,192],[80,200],[80,208],[80,216],[80,224],[88,104],[88,112],[88,120],[88,128],[88,136],[88,144],[88,152],[88,160],[88,168],[88,176],[88,184],[88,192],[88,200],[88,208],[88,216],[88,224],[96,104],[96,112],[96,120],[96,128],[96,136],[96,144],[96,152],[96,160],[96,168],[96,176],[96,184],[96,192],[96,200],[96,208],[96,216],[104,88],[104,96],[104,104],[104,112],[104,120],[104,128],[104,136],[104,144],[104,152],[104,160],[104,168],[104,176],[104,184],[104,192],[104,200],[104,208],[104,216],[112,80],[112,88],[112,96],[112,104],[112,112],[112,120],[112,128],[112,136],[112,144],[112,152],[112,160],[112,168],[112,176],[112,184],[112,192],[112,200],[112,208],[112,216],[120,72],[120,80],[120,88],[120,96],[120,104],[120,112],[120,120],[120,128],[120,136],[120,144],[120,152],[120,160],[120,168],[120,176],[120,184],[120,192],[120,200],[120,208],[120,216],[128,64],[128,72],[128,80],[128,88],[128,96],[128,104],[128,112],[128,120],[128,128],[128,136],[128,144],[128,152],[128,160],[128,168],[128,176],[128,184],[128,192],[128,200],[128,208],[136,64],[136,72],[136,80],[136,88],[136,96],[136,104],[136,112],[136,120],[136,128],[136,136],[136,144],[136,152],[136,160],[136,168],[136,176],[136,184],[136,192],[136,200],[136,208],[144,56],[144,64],[144,72],[144,80],[144,88],[144,96],[144,104],[144,112],[144,120],[144,128],[144,136],[144,144],[144,152],[144,160],[144,168],[144,176],[144,184],[144,192],[144,200],[144,208],[152,64],[152,72],[152,80],[152,88],[152,96],[152,104],[152,112],[152,120],[152,128],[152,136],[152,144],[152,152],[152,160],[152,168],[152,176],[152,184],[152,192],[152,200],[152,208],[160,64],[160,72],[160,80],[160,88],[160,96],[160,104],[160,112],[160,120],[160,128],[160,136],[160,144],[160,152],[160,160],[160,168],[160,176],[160,184],[160,192],[160,200],[160,208],[168,56],[168,64],[168,72],[168,80],[168,88],[168,96],[168,104],[168,112],[168,120],[168,128],[168,136],[168,144],[168,152],[168,160],[168,168],[168,176],[168,184],[168,192],[168,200],[176,48],[176,56],[176,64],[176,72],[176,80],[176,88],[176,96],[176,104],[176,112],[176,120],[176,128],[176,136],[176,144],[176,152],[176,160],[176,168],[176,176],[176,184],[176,192],[176,200],[184,40],[184,48],[184,56],[184,64],[184,72],[184,80],[184,88],[184,96],[184,104],[184,112],[184,120],[184,128],[184,136],[184,144],[184,152],[184,160],[184,168],[184,176],[184,184],[184,192],[184,200],[192,40],[192,48],[192,56],[192,64],[192,72],[192,80],[192,88],[192,96],[192,104],[192,112],[192,120],[192,128],[192,136],[192,144],[192,152],[192,160],[192,168],[192,176],[192,184],[192,192],[192,200],[192,208],[200,40],[200,48],[200,56],[200,64],[200,72],[200,80],[200,88],[200,96],[200,104],[200,112],[200,120],[200,128],[200,136],[200,144],[200,152],[200,160],[200,168],[200,176],[200,184],[200,192],[200,200],[200,208],[208,40],[208,48],[208,56],[208,64],[208,72],[208,80],[208,88],[208,96],[208,104],[208,112],[208,120],[208,128],[208,136],[208,144],[208,152],[208,160],[208,168],[208,176],[208,184],[208,192],[208,200],[208,208],[208,216],[208,224],[216,40],[216,48],[216,56],[216,64],[216,72],[216,80],[216,88],[216,96],[216,104],[216,112],[216,120],[216,128],[216,136],[216,144],[216,152],[216,160],[216,168],[216,176],[216,184],[216,192],[216,200],[216,208],[216,216],[216,224],[216,232],[224,40],[224,48],[224,56],[224,64],[224,72],[224,80],[224,88],[224,96],[224,104],[224,112],[224,120],[224,128],[224,136],[224,144],[224,152],[224,160],[224,168],[224,176],[224,184],[224,192],[224,200],[224,208],[224,216],[224,232],[232,80],[232,88],[232,96],[232,104],[232,112],[232,120],[232,128],[232,136],[232,144],[232,152],[232,160],[232,168],[232,176],[232,184],[232,192],[232,200],[232,208],[232,216],[232,224],[232,232],[240,80],[240,88],[240,96],[240,104],[240,112],[240,120],[240,128],[240,136],[240,144],[240,152],[240,160],[240,168],[240,176],[240,184],[240,192],[240,200],[240,208],[240,216],[240,224],[240,232],[248,88],[248,96],[248,104],[248,112],[248,120],[248,128],[248,136],[248,144],[248,152],[248,160],[248,168],[248,176],[248,184],[248,192],[248,200],[248,208],[248,216],[248,224],[248,232],[248,240],[256,88],[256,96],[256,104],[256,112],[256,120],[256,128],[256,136],[256,144],[256,152],[256,160],[256,168],[256,176],[256,184],[256,192],[256,200],[256,208],[256,216],[256,224],[256,232],[256,240],[256,248],[256,256],[264,64],[264,72],[264,80],[264,88],[264,96],[264,104],[264,112],[264,120],[264,128],[264,136],[264,144],[264,152],[264,160],[264,168],[264,176],[264,184],[264,192],[264,200],[264,208],[264,216],[264,224],[264,232],[264,240],[264,248],[264,256],[272,32],[272,40],[272,48],[272,56],[272,64],[272,72],[272,80],[272,88],[272,96],[272,104],[272,112],[272,120],[272,128],[272,136],[272,144],[272,152],[272,160],[272,168],[272,176],[272,184],[272,192],[272,200],[272,208],[272,216],[272,224],[272,232],[272,240],[272,248],[272,256],[280,40],[280,48],[280,56],[280,64],[280,72],[280,80],[280,88],[280,96],[280,104],[280,112],[280,120],[280,128],[280,136],[280,144],[280,152],[280,160],[280,168],[280,176],[280,184],[280,192],[280,200],[280,208],[280,216],[280,224],[280,232],[280,240],[280,248],[280,256],[288,56],[288,64],[288,72],[288,80],[288,88],[288,96],[288,104],[288,112],[288,120],[288,128],[288,136],[288,144],[288,152],[288,160],[288,168],[288,176],[288,184],[288,192],[288,200],[288,208],[288,216],[288,224],[288,232],[288,240],[288,248],[288,256],[296,64],[296,72],[296,80],[296,88],[296,96],[296,104],[296,112],[296,120],[296,128],[296,136],[296,144],[296,152],[296,160],[296,168],[296,176],[296,184],[296,192],[296,200],[296,208],[296,216],[296,224],[296,232],[296,240],[296,248],[296,256],[296,288],[296,296],[304,88],[304,96],[304,104],[304,112],[304,120],[304,128],[304,136],[304,144],[304,152],[304,160],[304,168],[304,176],[304,184],[304,192],[304,200],[304,208],[304,216],[304,224],[304,232],[304,240],[304,248],[304,256],[304,264],[304,288],[304,296],[304,304],[312,104],[312,112],[312,120],[312,128],[312,136],[312,144],[312,152],[312,160],[312,168],[312,176],[312,184],[312,192],[312,200],[312,208],[312,216],[312,224],[312,232],[312,240],[312,248],[312,256],[312,288],[312,296],[312,304],[320,112],[320,120],[320,128],[320,136],[320,144],[320,152],[320,160],[320,168],[320,176],[320,184],[320,192],[320,200],[320,208],[320,216],[320,224],[320,232],[320,240],[320,248],[320,256],[320,288],[320,296],[328,120],[328,128],[328,136],[328,144],[328,152],[328,160],[328,168],[328,176],[328,184],[328,192],[328,200],[328,208],[328,216],[328,224],[328,232],[328,240],[328,248],[336,128],[336,136],[336,144],[336,152],[336,160],[336,168],[336,176],[336,184],[336,192],[336,200],[336,208],[336,216],[336,224],[336,232],[336,240],[336,248],[344,144],[344,152],[344,160],[344,168],[344,176],[344,184],[344,192],[344,200],[344,208],[344,216],[344,224],[344,232],[352,152],[352,160],[352,168],[352,176],[352,184],[352,192],[352,200],[352,208],[352,216],[360,168],[360,176],[360,184],[360,192],[360,200]];

export function AustraliaPropertiesMap({ properties }: AustraliaPropertiesMapProps) {
  const router = useRouter();

  if (!properties || properties.length === 0) return null;

  const pins = properties.map((p) => ({
    ...getPropertyCoords(p),
    label: `${p.suburb}, ${p.state} ${p.postcode}`,
    id: p.id,
  }));

  return (
    <TooltipProvider delayDuration={0}>
      <svg
        viewBox={`0 0 ${SVG_W} ${SVG_H}`}
        className="w-full h-auto"
        role="img"
        aria-label={`Map of Australia showing ${properties.length} ${properties.length === 1 ? "property" : "properties"}`}
        data-testid="australia-map"
      >
        <style>{`
          @keyframes map-pulse {
            0% { r: 14; opacity: 0.25; }
            100% { r: 22; opacity: 0; }
          }
          .map-pulse {
            fill: var(--color-green-700);
            animation: map-pulse 2.5s ease-out infinite;
          }
        `}</style>

        {/* Dot matrix grid */}
        <g className="fill-foreground/20 dark:fill-foreground/25">
          {DOTS.map(([x, y], i) => (
            <circle key={i} cx={x} cy={y} r={1.2} />
          ))}
        </g>

        {/* Property markers */}
        {pins.map((pin, idx) => (
          <Tooltip key={pin.id}>
            <TooltipTrigger asChild>
              <g
                className="cursor-pointer"
                data-testid="map-pin"
                onClick={() => router.push(`/properties/${pin.id}`)}
              >
                {/* Pulse ring */}
                <circle
                  cx={pin.cx}
                  cy={pin.cy}
                  r={14}
                  className="map-pulse"
                  style={{ animationDelay: `${idx * 0.4}s` }}
                />
                {/* Glow */}
                <circle
                  cx={pin.cx}
                  cy={pin.cy}
                  r={14}
                  className="fill-green-700/10 dark:fill-green-500/10"
                />
                {/* Outer ring */}
                <circle
                  cx={pin.cx}
                  cy={pin.cy}
                  r={7}
                  className="fill-green-700/25 dark:fill-green-500/25"
                />
                {/* Core dot */}
                <circle
                  cx={pin.cx}
                  cy={pin.cy}
                  r={4}
                  className="fill-green-700 dark:fill-green-500"
                />
                {/* Center highlight */}
                <circle
                  cx={pin.cx}
                  cy={pin.cy}
                  r={1.8}
                  className="fill-white dark:fill-gray-900"
                />
              </g>
            </TooltipTrigger>
            <TooltipContent side="top" className="text-xs">
              {pin.label}
            </TooltipContent>
          </Tooltip>
        ))}
      </svg>
    </TooltipProvider>
  );
}
