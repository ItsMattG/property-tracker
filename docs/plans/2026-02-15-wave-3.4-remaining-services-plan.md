# Wave 3.4 — Restructure All Remaining Flat Services Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Move ~30 flat service files into 8 domain subdirectories with barrel re-exports.

**Architecture:** Same pattern as Wave 3.2/3.3 — create subdirectory, move files, create barrel with named re-exports, update all consumers, co-locate tests. One commit per subdirectory.

**Tech Stack:** TypeScript, Vitest

**Design doc:** `docs/plans/2026-02-15-wave-3.4-remaining-services-design.md`

---

## Tech Notes

- All 30 files are clean (no anti-patterns to fix) — this is purely mechanical
- `notification.ts` is the most cross-cutting service (11 consumers across 8 cron jobs)
- Cross-group deps: chat-tools → compliance, taxOptimization router → depreciation-extract
- `loanPack.ts` has client-side consumers — barrel must not include server-only code, or clients import directly
- `document-extraction.ts` and `settlement-extract.ts` have a client component consumer (`SettlementUpload.tsx`) — same concern

---

## Task 1: Create worktree + all directories

```bash
git worktree add ~/worktrees/property-tracker/wave-3.4 -b refactor/wave-3.4-remaining-services develop
cp ~/Documents/property-tracker/.env.local ~/worktrees/property-tracker/wave-3.4/.env.local
cd ~/worktrees/property-tracker/wave-3.4
mkdir -p src/server/services/{chat,email,tax,compliance,property-analysis,lending,notification,analytics}/__tests__
```

Create empty barrel `index.ts` in each new directory. Commit: `refactor: scaffold Wave 3.4 service directories`

---

## Task 2: Move chat services (3 files)

**Move:**
- `services/chat.ts` → `services/chat/chat.ts`
- `services/chat-system-prompt.ts` → `services/chat/system-prompt.ts`
- `services/chat-tools.ts` → `services/chat/tools.ts`

**Move tests:**
- `services/__tests__/chat.test.ts` → `services/chat/__tests__/chat.test.ts`
- `services/__tests__/chat-system-prompt.test.ts` → `services/chat/__tests__/system-prompt.test.ts`
- `services/__tests__/chat-tools.test.ts` → `services/chat/__tests__/tools.test.ts`

**Update consumer:** `src/app/api/chat/route.ts` — all 3 imports change from `@/server/services/chat*` to `@/server/services/chat`

**Cross-group dep:** `chat-tools.ts` imports from `compliance.ts` — update to `../compliance` (relative, since compliance will also move later — use `@/server/services/compliance` as stable path for now, then update in Task 5)

**Barrel + type check + commit:** `refactor: move chat services to services/chat/`

---

## Task 3: Move email services (5 files)

**Move:**
- `services/email-processing.ts` → `services/email/processing.ts`
- `services/email-forwarding.ts` → `services/email/forwarding.ts`
- `services/email-sender-check.ts` → `services/email/sender-check.ts`
- `services/gmail-sync.ts` → `services/email/gmail-sync.ts`
- `services/gmail-token.ts` → `services/email/gmail-token.ts`

**No test files exist for these.**

**Update consumers:**
- `src/server/routers/email.ts`: 3 imports (processing, forwarding, gmail-sync)
- `src/server/routers/emailConnection.ts`: gmail-sync import
- `src/app/api/webhooks/inbound-email/route.ts`: processing, forwarding, sender-check imports

**Internal dep:** `gmail-sync.ts` imports `gmail-token.ts` — update to `./gmail-token`

**Barrel + type check + commit:** `refactor: move email services to services/email/`

---

## Task 4: Move tax services (2 files)

**Move:**
- `services/tax-position.ts` → `services/tax/position.ts`
- `services/cgt.ts` → `services/tax/cgt.ts`

**Move tests:**
- `services/__tests__/tax-position.test.ts` → `services/tax/__tests__/position.test.ts`
- `services/__tests__/cgt.test.ts` → `services/tax/__tests__/cgt.test.ts`

**Update consumers:**
- `src/server/routers/taxPosition.ts`: tax-position import
- `src/server/routers/cgt.ts`: cgt import
- `src/server/services/transaction/tax-forecast.ts`: `../tax-position` → `../tax/position` or barrel
- `src/server/services/transaction/mytax.ts`: `../tax-position` → `../tax/position` or barrel

**Barrel + type check + commit:** `refactor: move tax services to services/tax/`

---

## Task 5: Move compliance services (4 files)

**Move:**
- `services/compliance.ts` → `services/compliance/compliance.ts`
- `services/smsf-compliance.ts` → `services/compliance/smsf.ts`
- `services/trust-compliance.ts` → `services/compliance/trust.ts`
- `services/entity.ts` → `services/compliance/entity.ts`

**Move tests:**
- `services/__tests__/compliance.test.ts` → `services/compliance/__tests__/compliance.test.ts`
- `services/__tests__/entity.test.ts` → `services/compliance/__tests__/entity.test.ts`

**Update consumers:**
- `src/server/routers/compliance.ts`, `smsfCompliance.ts`, `trustCompliance.ts`
- `src/server/services/chat/tools.ts`: update compliance import to `../compliance` barrel

**Barrel + type check + commit:** `refactor: move compliance services to services/compliance/`

---

## Task 6: Move property-analysis services (8 files)

**Move:**
- `services/document-extraction.ts` → `services/property-analysis/document-extraction.ts`
- `services/depreciation-extract.ts` → `services/property-analysis/depreciation-extract.ts`
- `services/listing-extraction.ts` → `services/property-analysis/listing-extraction.ts`
- `services/settlement-extract.ts` → `services/property-analysis/settlement-extract.ts`
- `services/valuation.ts` → `services/property-analysis/valuation.ts`
- `services/property-matcher.ts` → `services/property-analysis/property-matcher.ts`
- `services/suburb-data.ts` → `services/property-analysis/suburb-data.ts`
- `services/climate-risk.ts` → `services/property-analysis/climate-risk.ts`

**Move tests:** document-extraction, listing-extraction, settlement-extract, valuation, property-matcher, climate-risk (6 test files)

**Update consumers (many):**
- `src/server/routers/documents.ts`: document-extraction, property-matcher
- `src/server/routers/documentExtraction.ts`: document-extraction, property-matcher
- `src/server/routers/settlement.ts`: settlement-extract
- `src/server/routers/similarProperties.ts`: listing-extraction
- `src/server/routers/propertyValue.ts`: valuation
- `src/server/routers/performanceBenchmarking.ts`: suburb-data
- `src/server/routers/property.ts`: climate-risk
- `src/server/routers/taxOptimization.ts`: depreciation-extract
- `src/app/api/cron/valuations/route.ts`: valuation
- `src/components/settlement/SettlementUpload.tsx`: document-extraction, settlement-extract (client import — import directly, not from barrel)
- `src/lib/seed/generators/properties.ts`: climate-risk
- `src/scripts/backfill-climate-risk.ts`: climate-risk

**IMPORTANT:** `SettlementUpload.tsx` is a client component. It must import directly from the specific file, not from the barrel (barrel may include server-only code).

**Barrel + type check + commit:** `refactor: move property-analysis services to services/property-analysis/`

---

## Task 7: Move lending services (3 files)

**Move:**
- `services/loanPack.ts` → `services/lending/loan-pack.ts` (rename to kebab-case)
- `services/loan-comparison.ts` → `services/lending/loan-comparison.ts`
- `services/forecast.ts` → `services/lending/forecast.ts`

**Move tests:**
- `services/__tests__/loan-comparison.test.ts` → `services/lending/__tests__/loan-comparison.test.ts`
- `services/__tests__/forecast.test.ts` → `services/lending/__tests__/forecast.test.ts`

**Update consumers:**
- `src/server/routers/loanPack.ts`: loanPack import
- `src/server/routers/loanComparison.ts`: loan-comparison import
- `src/server/routers/forecast.ts`: forecast import
- `src/lib/loan-pack-pdf.ts`: loanPack import
- `src/components/loanPack/LoanPackReport.tsx`: loanPack (client — import directly)
- `src/components/loanPack/DownloadLoanPackPDFButton.tsx`: loanPack (client — import directly)
- `src/app/share/loan-pack/[token]/page.tsx`: loanPack import
- `src/app/api/cron/refinance-scan/route.ts`: loan-comparison import

**IMPORTANT:** Client components (`LoanPackReport.tsx`, `DownloadLoanPackPDFButton.tsx`) must import directly, not from barrel.

**Barrel + type check + commit:** `refactor: move lending services to services/lending/`

---

## Task 8: Move notification services (3 files)

**Move:**
- `services/notification.ts` → `services/notification/notification.ts`
- `services/support-tickets.ts` → `services/notification/support-tickets.ts`
- `services/milestone-preferences.ts` → `services/notification/milestone-preferences.ts`

**Move tests:**
- `services/__tests__/notification.test.ts` → `services/notification/__tests__/notification.test.ts`
- `services/__tests__/notification-refinance.test.ts` → `services/notification/__tests__/notification-refinance.test.ts`
- `services/__tests__/notification-tasks.test.ts` → `services/notification/__tests__/notification-tasks.test.ts`
- `services/__tests__/support-tickets.test.ts` → `services/notification/__tests__/support-tickets.test.ts`
- `services/__tests__/milestone-preferences.test.ts` → `services/notification/__tests__/milestone-preferences.test.ts`

**Update consumers (11+ for notification alone):**
- `src/server/routers/notification.ts`, `feedback.ts`, `supportTickets.ts`, `milestonePreferences.ts`
- `src/app/api/cron/tax-suggestions/route.ts`
- `src/app/api/cron/weekly-digest/route.ts`
- `src/app/api/cron/task-reminders/route.ts`
- `src/app/api/cron/trial-reminders/route.ts`
- `src/app/api/cron/equity-milestones/route.ts`
- `src/app/api/cron/compliance-reminders/route.ts`
- `src/app/api/cron/rba-rate-check/route.ts`
- `src/app/api/cron/refinance-scan/route.ts`
- `src/lib/auth.ts`

**Barrel + type check + commit:** `refactor: move notification services to services/notification/`

---

## Task 9: Move analytics services (3 files)

**Move:**
- `services/benchmarking.ts` → `services/analytics/benchmarking.ts`
- `services/performance-benchmarking.ts` → `services/analytics/performance-benchmarking.ts`
- `services/rental-yield.ts` → `services/analytics/rental-yield.ts`

**Move tests:**
- `services/__tests__/benchmarking.test.ts` → `services/analytics/__tests__/benchmarking.test.ts`
- `services/__tests__/rental-yield.test.ts` → `services/analytics/__tests__/rental-yield.test.ts`

**Update consumers:**
- `src/server/routers/benchmarking.ts`
- `src/server/routers/performanceBenchmarking.ts`
- `src/server/routers/rentalYield.ts`

**Barrel + type check + commit:** `refactor: move analytics services to services/analytics/`

---

## Task 10: Full verification

1. `npx tsc --noEmit`
2. `npm run lint`
3. `npx vitest run src/server/services/`
4. `npx vitest run src/server/routers/__tests__/`
5. `npm run build`

Fix any issues, commit.

---

## Task 11: Create PR

```bash
gh pr create --base develop --title "refactor: Wave 3.4 — restructure remaining services into domain subdirectories" --body "..."
```
