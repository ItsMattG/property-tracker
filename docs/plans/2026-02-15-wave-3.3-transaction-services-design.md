# Wave 3.3 — Transaction Services Restructure (Design)

**Date:** 2026-02-15
**Status:** Approved
**Scope:** Full cleanup — move + extract + router refactor in one PR

## Goal

Restructure all transaction-related services into `services/transaction/`, extract business logic from the transaction router into services, move notes CRUD to the repository layer, and fix anti-patterns in every moved file.

## New Directory Structure

```
src/server/services/transaction/
├── index.ts              # Barrel re-exports (named, no export *)
├── category.ts           # deriveTransactionFields, categoryValues, type maps
├── csv-export.ts         # CSV export formatting (merged with existing export.ts)
├── import.ts             # CSV import orchestration (loop + error collection)
├── recurring.ts          # ← from services/recurring.ts
├── reports.ts            # ← from services/reports.ts
├── tax-forecast.ts       # ← from services/tax-forecast.ts
├── tax-optimization.ts   # ← from services/tax-optimization.ts
├── yoy-comparison.ts     # ← from services/yoy-comparison.ts
├── audit-checks.ts       # ← from services/audit-checks.ts
├── mytax.ts              # ← from services/mytax.ts
├── portfolio.ts          # ← from services/portfolio.ts
└── __tests__/            # Co-located tests (moved from services/__tests__/)
```

## Extractions from Transaction Router

| What | Source | Destination | Type |
|------|--------|-------------|------|
| `deriveTransactionFields()` + `categoryValues` | `routers/transaction.ts` L11-72 | `services/transaction/category.ts` | Pure function |
| CSV export formatting | `routers/transaction.ts` L103-133 | `services/transaction/csv-export.ts` | Merge with `services/export.ts` |
| Import orchestration loops | `routers/transaction.ts` L300-382 | `services/transaction/import.ts` | Extract loop + error collection |
| Notes CRUD (4 endpoints) | `routers/transaction.ts` L412-502 | `repositories/transaction.repository.ts` | Direct `ctx.db` → repo methods |

## Router After Refactor

The transaction router becomes a thin controller (~200 lines):
- Validation schemas + procedure types
- Delegates to `services/transaction/` for business logic
- Delegates to `ctx.uow.transactions` for data access
- No direct `ctx.db` calls remain

## Anti-Pattern Audit Checklist (per moved file)

- [ ] No `any` / `unknown` where real types exist
- [ ] No `Record<string, unknown>` — use `Partial<SchemaType>`
- [ ] `sql<number>\`COUNT(*)::int\`` for aggregations
- [ ] Static imports only (no dynamic `await import()`)
- [ ] Named re-exports in barrel (no `export *`)
- [ ] `Promise.all()` for independent queries
- [ ] Proper schema types from Drizzle `$inferSelect` / `$inferInsert`

## What Stays Put

- `services/banking/csv-import.ts` — CSV **parsing** is banking domain
- `services/banking/categorization.ts` — AI categorization is banking domain
- `services/cgt.ts` — Capital gains is its own domain (light transaction dependency)

## Consumer Updates

All files importing from old paths need updating:
- Transaction router → import from `services/transaction/`
- Any router importing `reports`, `recurring`, `tax-*`, etc. from old flat paths
- Test files referencing old paths
- Barrel `services/index.ts` if one exists
