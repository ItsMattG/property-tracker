# Wave 3.4 — Restructure All Remaining Flat Services (Design)

**Date:** 2026-02-15
**Status:** Approved
**Scope:** Move ~30 flat service files into 8 domain subdirectories, single PR

## Goal

Eliminate all remaining flat service files by organizing them into domain-specific subdirectories with barrel re-exports. Fix anti-patterns in every moved file.

## New Subdirectories

| Directory | Files | Approx LOC |
|-----------|-------|------------|
| `services/chat/` | chat.ts, chat-system-prompt.ts, chat-tools.ts | 409 |
| `services/email/` | email-processing.ts, email-forwarding.ts, email-sender-check.ts, gmail-sync.ts, gmail-token.ts | 734 |
| `services/tax/` | tax-position.ts, cgt.ts | 352 |
| `services/compliance/` | compliance.ts, smsf-compliance.ts, trust-compliance.ts, entity.ts | 255 |
| `services/property-analysis/` | document-extraction.ts, depreciation-extract.ts, listing-extraction.ts, settlement-extract.ts, valuation.ts, property-matcher.ts, suburb-data.ts, climate-risk.ts | 900+ |
| `services/lending/` | loanPack.ts, loan-comparison.ts, forecast.ts | 469 |
| `services/notification/` | notification.ts, support-tickets.ts, milestone-preferences.ts | 462 |
| `services/analytics/` | benchmarking.ts, performance-benchmarking.ts, rental-yield.ts | 337 |

## Files That Stay Flat

- `portfolio-access.ts` — cross-cutting access control
- `share.ts` — portfolio sharing logic
- `subscription.ts` — Stripe subscription management
- `onboarding.ts` — cross-cutting user lifecycle
- `referral.ts` — 5 lines, too small to move
- `task.ts` — small utility
- `rate-data.ts` — standalone data utility
- `vector-generation.ts` — AI vector generation

## Pattern (same as Wave 3.2/3.3)

Each subdirectory:
- Flat file structure, no sub-nesting
- `index.ts` barrel with named re-exports (no `export *`)
- Co-located `__tests__/` directory (move from `services/__tests__/`)
- Anti-pattern audit on every moved file
- All consumers updated to import from barrel or direct file

## Anti-Pattern Audit Checklist (per file)

- No `any` / `unknown` where real types exist
- No `Record<string, unknown>` — use schema types
- `sql<number>\`COUNT(*)::int\`` for aggregations
- Static imports only
- Named re-exports in barrel
- `Promise.all()` for independent queries
