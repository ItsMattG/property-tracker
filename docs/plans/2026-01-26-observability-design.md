# Observability Design

## Overview

Add comprehensive observability to PropertyTracker: structured logging, custom metrics, dashboards, and alerting using Axiom alongside existing Sentry error tracking.

## Architecture

**Current state:**
```
App → Sentry (errors) → Sentry Dashboard
    → Vercel Analytics (page views) → Vercel Dashboard
    → console.log → Vercel Logs (ephemeral, 1hr retention)
```

**Target state:**
```
App → Sentry (errors, replay, traces) → Sentry Dashboard + Alerts
    → Vercel Analytics (page views) → Vercel Dashboard
    → Axiom (logs, metrics) → Axiom Dashboard + Alerts
```

## Tool Responsibilities

| Need | Tool |
|------|------|
| Error tracking | Sentry (existing) |
| Session replay | Sentry (existing) |
| Log aggregation | Axiom (new) |
| Custom metrics | Axiom (new) |
| Dashboards | Axiom (new) |
| Alerting | Axiom + Sentry |
| Page analytics | Vercel Analytics (existing) |

## Structured Logging

Upgrade `src/lib/logger.ts` to emit structured JSON:

```typescript
{
  "timestamp": "2026-01-26T10:30:00.000Z",
  "level": "info",
  "message": "Bank sync completed",
  "service": "property-tracker",
  "environment": "production",
  "requestId": "req_abc123",
  "userId": "user_xyz",
  "duration": 1234,
  "context": {
    "accountId": "acc_123",
    "transactionCount": 47
  }
}
```

**Correlation IDs:**
- Generate `requestId` in middleware for each request
- Pass through tRPC context so all logs in a request chain share the same ID

**Auto-enrichment:**
- Environment (production/development)
- Vercel region (from `VERCEL_REGION`)
- Git commit SHA (from `VERCEL_GIT_COMMIT_SHA`)

## Custom Metrics

### API Performance (automatic via middleware)
- `api.request.duration` - Response time per endpoint
- `api.request.count` - Request count by endpoint and status code
- `api.error.count` - Errors by endpoint and error type

### Database Metrics (wrap Drizzle queries)
- `db.query.duration` - Query execution time
- `db.query.count` - Query count by operation

### Business Metrics (explicit in code)
- `bank_sync.duration` - Time to sync a bank account
- `bank_sync.transactions` - Transactions fetched per sync
- `export.generated` - CSV/PDF exports by type
- `property.created` - New properties added
- `categorization.override` - Manual category corrections

### Usage
```typescript
import { metrics } from '@/lib/axiom';

metrics.timing('bank_sync.duration', durationMs, { accountId });
metrics.increment('export.generated', { type: 'csv' });
```

## Dashboards

### Operations Overview
- Request volume over time (line chart)
- P50/P95/P99 API latency (line chart)
- Error rate % (line chart with threshold line)
- Top 10 slowest endpoints (bar chart)
- Bank sync success rate (single stat)

### Business Metrics
- Properties created per day
- Bank syncs per day
- Exports generated by type
- Active users (unique userIds)

## Alerting

### Axiom Alerts
| Alert | Condition | Channel |
|-------|-----------|---------|
| High error rate | >5% errors in 5min | Email + Slack |
| Slow API | P95 latency >3s for 5min | Email |
| Bank sync failures | >3 failed syncs in 1hr | Email + Slack |

### Sentry Alerts (existing)
| Alert | Condition | Channel |
|-------|-----------|---------|
| New error | First occurrence | Email |
| Error spike | 10x normal volume | Email |

## Implementation Steps

### One-time Setup (manual)
1. Create Axiom account at axiom.co (free tier - 500GB/month)
2. In Vercel dashboard: Settings → Integrations → Add Axiom
3. This auto-forwards all Vercel logs to Axiom

### Code Changes

1. **Add Axiom SDK**
   ```bash
   npm install @axiomhq/js
   ```

2. **Create `src/lib/axiom.ts`**
   - Axiom client initialization
   - `metrics.timing()`, `metrics.increment()` helpers
   - Flush on serverless function end

3. **Update `src/lib/logger.ts`**
   - Structured JSON format
   - Request ID from context
   - User ID enrichment
   - Send to Axiom in addition to console

4. **Add middleware for correlation IDs**
   - Generate `requestId` in `middleware.ts`
   - Pass to tRPC context

5. **Instrument key paths**
   - Wrap bank sync with timing
   - Wrap export generation with timing
   - Add metrics to tRPC middleware for automatic API tracking

6. **Create dashboards in Axiom UI**

7. **Configure alerts in Axiom UI**

## Files Changed

| File | Change |
|------|--------|
| `package.json` | Add `@axiomhq/js` |
| `src/lib/axiom.ts` | New - Axiom client and metrics helpers |
| `src/lib/logger.ts` | Update - Structured JSON, Axiom integration |
| `src/middleware.ts` | Update - Add requestId generation |
| `src/server/trpc.ts` | Update - Pass requestId to context |
| Bank sync service | Update - Add timing metrics |
| Export service | Update - Add timing metrics |
