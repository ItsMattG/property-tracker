# PropertyTracker v0.1 Polish & v0.5 Features Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix critical v0.1 gaps (property edit, manual transactions, dashboard stats) then add v0.5 features (loans module, CSV import, auto-categorization rules).

**Architecture:** Next.js App Router with tRPC for type-safe API, Clerk for auth, Drizzle ORM with PostgreSQL. Extend existing schema with loans table, add new tRPC routers, create new UI pages following existing patterns.

**Tech Stack:** Next.js 16, tRPC, Drizzle ORM, PostgreSQL, Clerk, React Hook Form, Zod, shadcn/ui, Tailwind CSS

---

## Section 1: V0.1 Polish (Critical Gaps)

### Task 1: Property Edit Page

**Files:**
- Create: `src/app/(dashboard)/properties/[id]/edit/page.tsx`

**Step 1: Create edit page that fetches and displays property form**

Create `src/app/(dashboard)/properties/[id]/edit/page.tsx`:

```typescript
"use client";

import { useParams, useRouter } from "next/navigation";
import { PropertyForm, PropertyFormValues } from "@/components/properties/PropertyForm";
import { trpc } from "@/lib/trpc/client";
import { toast } from "sonner";

export default function EditPropertyPage() {
  const params = useParams();
  const router = useRouter();
  const propertyId = params.id as string;

  const { data: property, isLoading } = trpc.property.get.useQuery({ id: propertyId });
  const updateProperty = trpc.property.update.useMutation({
    onSuccess: () => {
      toast.success("Property updated successfully");
      router.push("/properties");
    },
    onError: (error) => {
      toast.error(error.message || "Failed to update property");
    },
  });

  const handleSubmit = (values: PropertyFormValues) => {
    updateProperty.mutate({ id: propertyId, ...values });
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-2xl font-bold">Edit Property</h2>
          <p className="text-muted-foreground">Loading property details...</p>
        </div>
        <div className="h-96 rounded-lg bg-muted animate-pulse" />
      </div>
    );
  }

  if (!property) {
    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-2xl font-bold">Property Not Found</h2>
          <p className="text-muted-foreground">
            The property you're looking for doesn't exist.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold">Edit Property</h2>
        <p className="text-muted-foreground">
          Update the details for {property.address}
        </p>
      </div>

      <div className="max-w-2xl">
        <PropertyForm
          defaultValues={{
            address: property.address,
            suburb: property.suburb,
            state: property.state,
            postcode: property.postcode,
            purchasePrice: property.purchasePrice,
            purchaseDate: property.purchaseDate,
            entityName: property.entityName,
          }}
          onSubmit={handleSubmit}
          isLoading={updateProperty.isPending}
        />
      </div>
    </div>
  );
}
```

**Step 2: Run dev server to verify page loads**

Run: `npm run dev`
Navigate to: `/properties` → click edit on a property
Expected: Edit form displays with property data pre-filled

**Step 3: Commit**

```bash
git add src/app/\(dashboard\)/properties/\[id\]/edit/page.tsx
git commit -m "feat: add property edit page"
```

---

### Task 2: Manual Transaction Creation - Schema Update

**Files:**
- Modify: `src/server/db/schema.ts`

**Step 1: Make bankAccountId nullable for manual transactions**

In `src/server/db/schema.ts`, update the transactions table (line 126-127):

```typescript
  bankAccountId: uuid("bank_account_id")
    .references(() => bankAccounts.id, { onDelete: "cascade" }),
```

Remove the `.notNull()` constraint to allow manual transactions without a bank account.

**Step 2: Push schema change**

Run: `npm run db:push`
Expected: Schema updated successfully

**Step 3: Commit**

```bash
git add src/server/db/schema.ts
git commit -m "feat: make bankAccountId nullable for manual transactions"
```

---

### Task 3: Manual Transaction Creation - Router

**Files:**
- Modify: `src/server/routers/transaction.ts`

**Step 1: Add create mutation to transaction router**

Add after line 80 (after the `list` query), before `updateCategory`:

```typescript
  create: protectedProcedure
    .input(
      z.object({
        propertyId: z.string().uuid(),
        date: z.string(),
        description: z.string().min(1, "Description is required"),
        amount: z.string().regex(/^-?\d+\.?\d*$/, "Invalid amount"),
        category: z.enum(categoryValues).default("uncategorized"),
        notes: z.string().optional(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const incomeCategories = ["rental_income", "other_rental_income"];
      const capitalCategories = [
        "stamp_duty",
        "conveyancing",
        "buyers_agent_fees",
        "initial_repairs",
      ];
      const nonDeductibleCategories = [
        ...capitalCategories,
        "transfer",
        "personal",
        "uncategorized",
      ];

      let transactionType: "income" | "expense" | "capital" | "transfer" | "personal" =
        "expense";
      if (incomeCategories.includes(input.category)) {
        transactionType = "income";
      } else if (capitalCategories.includes(input.category)) {
        transactionType = "capital";
      } else if (input.category === "transfer") {
        transactionType = "transfer";
      } else if (input.category === "personal") {
        transactionType = "personal";
      }

      const isDeductible = !nonDeductibleCategories.includes(input.category);

      const [transaction] = await ctx.db
        .insert(transactions)
        .values({
          userId: ctx.user.id,
          propertyId: input.propertyId,
          date: input.date,
          description: input.description,
          amount: input.amount,
          category: input.category,
          transactionType,
          isDeductible,
          notes: input.notes,
        })
        .returning();

      return transaction;
    }),

  delete: protectedProcedure
    .input(z.object({ id: z.string().uuid() }))
    .mutation(async ({ ctx, input }) => {
      await ctx.db
        .delete(transactions)
        .where(
          and(eq(transactions.id, input.id), eq(transactions.userId, ctx.user.id))
        );

      return { success: true };
    }),
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add src/server/routers/transaction.ts
git commit -m "feat: add transaction create and delete mutations"
```

---

### Task 4: Manual Transaction Creation - UI Dialog

**Files:**
- Create: `src/components/transactions/AddTransactionDialog.tsx`
- Modify: `src/app/(dashboard)/transactions/page.tsx`

**Step 1: Create the add transaction dialog component**

Create `src/components/transactions/AddTransactionDialog.tsx`:

```typescript
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { trpc } from "@/lib/trpc/client";
import { toast } from "sonner";
import { Plus } from "lucide-react";
import { CATEGORIES } from "@/lib/categories";

const transactionFormSchema = z.object({
  propertyId: z.string().uuid("Please select a property"),
  date: z.string().min(1, "Date is required"),
  description: z.string().min(1, "Description is required"),
  amount: z.string().regex(/^-?\d+\.?\d*$/, "Invalid amount"),
  category: z.string(),
  notes: z.string().optional(),
});

type TransactionFormValues = z.infer<typeof transactionFormSchema>;

interface AddTransactionDialogProps {
  onSuccess?: () => void;
}

export function AddTransactionDialog({ onSuccess }: AddTransactionDialogProps) {
  const [open, setOpen] = useState(false);
  const { data: properties } = trpc.property.list.useQuery();

  const form = useForm<TransactionFormValues>({
    resolver: zodResolver(transactionFormSchema),
    defaultValues: {
      propertyId: "",
      date: new Date().toISOString().split("T")[0],
      description: "",
      amount: "",
      category: "uncategorized",
      notes: "",
    },
  });

  const createTransaction = trpc.transaction.create.useMutation({
    onSuccess: () => {
      toast.success("Transaction added successfully");
      form.reset();
      setOpen(false);
      onSuccess?.();
    },
    onError: (error) => {
      toast.error(error.message || "Failed to add transaction");
    },
  });

  const handleSubmit = (values: TransactionFormValues) => {
    createTransaction.mutate({
      ...values,
      category: values.category as any,
    });
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>
          <Plus className="w-4 h-4 mr-2" />
          Add Transaction
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Add Manual Transaction</DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="propertyId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Property</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select property" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {properties?.map((property) => (
                        <SelectItem key={property.id} value={property.id}>
                          {property.address}, {property.suburb}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid grid-cols-2 gap-4">
              <FormField
                control={form.control}
                name="date"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Date</FormLabel>
                    <FormControl>
                      <Input type="date" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="amount"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Amount ($)</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        step="0.01"
                        placeholder="-150.00"
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Description</FormLabel>
                  <FormControl>
                    <Input placeholder="Council rates payment" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="category"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Category</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select category" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {CATEGORIES.map((cat) => (
                        <SelectItem key={cat.value} value={cat.value}>
                          {cat.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notes (optional)</FormLabel>
                  <FormControl>
                    <Input placeholder="Additional details..." {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <Button type="submit" className="w-full" disabled={createTransaction.isPending}>
              {createTransaction.isPending ? "Adding..." : "Add Transaction"}
            </Button>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

**Step 2: Create categories helper if it doesn't exist**

Create `src/lib/categories.ts`:

```typescript
export const CATEGORIES = [
  // Income
  { value: "rental_income", label: "Rental Income", type: "income" },
  { value: "other_rental_income", label: "Other Rental Income", type: "income" },
  // Expenses (Deductible)
  { value: "advertising", label: "Advertising", type: "expense" },
  { value: "body_corporate", label: "Body Corporate", type: "expense" },
  { value: "borrowing_expenses", label: "Borrowing Expenses", type: "expense" },
  { value: "cleaning", label: "Cleaning", type: "expense" },
  { value: "council_rates", label: "Council Rates", type: "expense" },
  { value: "gardening", label: "Gardening", type: "expense" },
  { value: "insurance", label: "Insurance", type: "expense" },
  { value: "interest_on_loans", label: "Interest on Loans", type: "expense" },
  { value: "land_tax", label: "Land Tax", type: "expense" },
  { value: "legal_expenses", label: "Legal Expenses", type: "expense" },
  { value: "pest_control", label: "Pest Control", type: "expense" },
  { value: "property_agent_fees", label: "Property Agent Fees", type: "expense" },
  { value: "repairs_and_maintenance", label: "Repairs & Maintenance", type: "expense" },
  { value: "capital_works_deductions", label: "Capital Works", type: "expense" },
  { value: "stationery_and_postage", label: "Stationery & Postage", type: "expense" },
  { value: "travel_expenses", label: "Travel Expenses", type: "expense" },
  { value: "water_charges", label: "Water Charges", type: "expense" },
  { value: "sundry_rental_expenses", label: "Sundry Expenses", type: "expense" },
  // Capital (CGT)
  { value: "stamp_duty", label: "Stamp Duty", type: "capital" },
  { value: "conveyancing", label: "Conveyancing", type: "capital" },
  { value: "buyers_agent_fees", label: "Buyer's Agent Fees", type: "capital" },
  { value: "initial_repairs", label: "Initial Repairs", type: "capital" },
  // Other
  { value: "transfer", label: "Transfer", type: "other" },
  { value: "personal", label: "Personal", type: "other" },
  { value: "uncategorized", label: "Uncategorized", type: "other" },
] as const;

export type CategoryValue = typeof CATEGORIES[number]["value"];
```

**Step 3: Update transactions page to include the dialog**

In `src/app/(dashboard)/transactions/page.tsx`, add the import and button:

Add import at top:
```typescript
import { AddTransactionDialog } from "@/components/transactions/AddTransactionDialog";
```

Add the dialog button next to the page heading (around line 85-90, in the header div):
```typescript
<div className="flex items-center justify-between">
  <div>
    <h2 className="text-2xl font-bold">Transactions</h2>
    <p className="text-muted-foreground">
      View and categorize your property transactions
    </p>
  </div>
  <AddTransactionDialog onSuccess={() => refetch()} />
</div>
```

**Step 4: Verify UI works**

Run: `npm run dev`
Navigate to: `/transactions` → click "Add Transaction"
Expected: Dialog opens with form fields

**Step 5: Commit**

```bash
git add src/components/transactions/AddTransactionDialog.tsx src/lib/categories.ts src/app/\(dashboard\)/transactions/page.tsx
git commit -m "feat: add manual transaction creation dialog"
```

---

### Task 5: Dashboard Stats - Add Stats Router

**Files:**
- Create: `src/server/routers/stats.ts`
- Modify: `src/server/routers/_app.ts`

**Step 1: Create stats router**

Create `src/server/routers/stats.ts`:

```typescript
import { router, protectedProcedure } from "../trpc";
import { properties, transactions } from "../db/schema";
import { eq, and, sql } from "drizzle-orm";

export const statsRouter = router({
  dashboard: protectedProcedure.query(async ({ ctx }) => {
    // Count properties
    const propertiesResult = await ctx.db
      .select({ count: sql<number>`count(*)::int` })
      .from(properties)
      .where(eq(properties.userId, ctx.user.id));

    // Count all transactions
    const transactionsResult = await ctx.db
      .select({ count: sql<number>`count(*)::int` })
      .from(transactions)
      .where(eq(transactions.userId, ctx.user.id));

    // Count uncategorized transactions
    const uncategorizedResult = await ctx.db
      .select({ count: sql<number>`count(*)::int` })
      .from(transactions)
      .where(
        and(
          eq(transactions.userId, ctx.user.id),
          eq(transactions.category, "uncategorized")
        )
      );

    return {
      propertyCount: propertiesResult[0]?.count ?? 0,
      transactionCount: transactionsResult[0]?.count ?? 0,
      uncategorizedCount: uncategorizedResult[0]?.count ?? 0,
    };
  }),
});
```

**Step 2: Add to app router**

In `src/server/routers/_app.ts`, add:

```typescript
import { statsRouter } from "./stats";

export const appRouter = router({
  property: propertyRouter,
  transaction: transactionRouter,
  banking: bankingRouter,
  stats: statsRouter,
});
```

**Step 3: Commit**

```bash
git add src/server/routers/stats.ts src/server/routers/_app.ts
git commit -m "feat: add dashboard stats router"
```

---

### Task 6: Dashboard Stats - Wire Up UI

**Files:**
- Modify: `src/app/(dashboard)/dashboard/page.tsx`

**Step 1: Update dashboard to fetch and display real stats**

Replace `src/app/(dashboard)/dashboard/page.tsx`:

```typescript
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Building2, ArrowLeftRight, AlertCircle } from "lucide-react";
import { trpc } from "@/lib/trpc/client";
import Link from "next/link";

export default function DashboardPage() {
  const { data: stats, isLoading } = trpc.stats.dashboard.useQuery();

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold">Welcome to PropertyTracker</h2>
        <p className="text-muted-foreground">
          Track your investment properties, automate bank feeds, and generate tax reports.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Link href="/properties">
          <Card className="hover:border-primary transition-colors cursor-pointer">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">Properties</CardTitle>
              <Building2 className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {isLoading ? (
                  <div className="h-8 w-8 bg-muted animate-pulse rounded" />
                ) : (
                  stats?.propertyCount ?? 0
                )}
              </div>
              <p className="text-xs text-muted-foreground">
                {stats?.propertyCount === 0
                  ? "Add your first property to get started"
                  : "Investment properties tracked"}
              </p>
            </CardContent>
          </Card>
        </Link>

        <Link href="/transactions">
          <Card className="hover:border-primary transition-colors cursor-pointer">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">Transactions</CardTitle>
              <ArrowLeftRight className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {isLoading ? (
                  <div className="h-8 w-8 bg-muted animate-pulse rounded" />
                ) : (
                  stats?.transactionCount ?? 0
                )}
              </div>
              <p className="text-xs text-muted-foreground">
                {stats?.transactionCount === 0
                  ? "Connect your bank to import transactions"
                  : "Total transactions imported"}
              </p>
            </CardContent>
          </Card>
        </Link>

        <Link href="/transactions?category=uncategorized">
          <Card className="hover:border-primary transition-colors cursor-pointer">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium">
                Uncategorized
              </CardTitle>
              <AlertCircle className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {isLoading ? (
                  <div className="h-8 w-8 bg-muted animate-pulse rounded" />
                ) : (
                  stats?.uncategorizedCount ?? 0
                )}
              </div>
              <p className="text-xs text-muted-foreground">
                {stats?.uncategorizedCount === 0
                  ? "All transactions categorized!"
                  : "Transactions needing review"}
              </p>
            </CardContent>
          </Card>
        </Link>
      </div>
    </div>
  );
}
```

**Step 2: Verify dashboard shows real data**

Run: `npm run dev`
Navigate to: `/dashboard`
Expected: Stats cards show actual counts from database

**Step 3: Commit**

```bash
git add src/app/\(dashboard\)/dashboard/page.tsx
git commit -m "feat: wire dashboard stats to real data"
```

---

## Section 2: V0.5 Features

### Task 7: Loans Module - Schema

**Files:**
- Modify: `src/server/db/schema.ts`

**Step 1: Add loan type enum and loans table**

Add after line 74 (after `transactionTypeEnum`):

```typescript
export const loanTypeEnum = pgEnum("loan_type", [
  "principal_and_interest",
  "interest_only",
]);

export const rateTypeEnum = pgEnum("rate_type", [
  "variable",
  "fixed",
  "split",
]);
```

Add after the `transactions` table (around line 143):

```typescript
export const loans = pgTable("loans", {
  id: uuid("id").primaryKey().defaultRandom(),
  userId: uuid("user_id")
    .references(() => users.id, { onDelete: "cascade" })
    .notNull(),
  propertyId: uuid("property_id")
    .references(() => properties.id, { onDelete: "cascade" })
    .notNull(),
  lender: text("lender").notNull(),
  accountNumberMasked: text("account_number_masked"),
  loanType: loanTypeEnum("loan_type").notNull(),
  rateType: rateTypeEnum("rate_type").notNull(),
  originalAmount: decimal("original_amount", { precision: 12, scale: 2 }).notNull(),
  currentBalance: decimal("current_balance", { precision: 12, scale: 2 }).notNull(),
  interestRate: decimal("interest_rate", { precision: 5, scale: 2 }).notNull(),
  fixedRateExpiry: date("fixed_rate_expiry"),
  repaymentAmount: decimal("repayment_amount", { precision: 12, scale: 2 }).notNull(),
  repaymentFrequency: text("repayment_frequency").notNull(), // weekly, fortnightly, monthly
  offsetAccountId: uuid("offset_account_id").references(() => bankAccounts.id, {
    onDelete: "set null",
  }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

Add loans relation to properties (update `propertiesRelations`):

```typescript
export const propertiesRelations = relations(properties, ({ one, many }) => ({
  user: one(users, {
    fields: [properties.userId],
    references: [users.id],
  }),
  transactions: many(transactions),
  bankAccounts: many(bankAccounts),
  loans: many(loans),
}));
```

Add loans relation:

```typescript
export const loansRelations = relations(loans, ({ one }) => ({
  user: one(users, {
    fields: [loans.userId],
    references: [users.id],
  }),
  property: one(properties, {
    fields: [loans.propertyId],
    references: [properties.id],
  }),
  offsetAccount: one(bankAccounts, {
    fields: [loans.offsetAccountId],
    references: [bankAccounts.id],
  }),
}));
```

Add type exports:

```typescript
export type Loan = typeof loans.$inferSelect;
export type NewLoan = typeof loans.$inferInsert;
```

**Step 2: Push schema**

Run: `npm run db:push`
Expected: Schema updated with new tables

**Step 3: Commit**

```bash
git add src/server/db/schema.ts
git commit -m "feat: add loans table schema"
```

---

### Task 8: Loans Module - Router

**Files:**
- Create: `src/server/routers/loan.ts`
- Modify: `src/server/routers/_app.ts`

**Step 1: Create loan router**

Create `src/server/routers/loan.ts`:

```typescript
import { z } from "zod";
import { router, protectedProcedure } from "../trpc";
import { loans } from "../db/schema";
import { eq, and } from "drizzle-orm";

const loanSchema = z.object({
  propertyId: z.string().uuid(),
  lender: z.string().min(1, "Lender is required"),
  accountNumberMasked: z.string().optional(),
  loanType: z.enum(["principal_and_interest", "interest_only"]),
  rateType: z.enum(["variable", "fixed", "split"]),
  originalAmount: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
  currentBalance: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
  interestRate: z.string().regex(/^\d+\.?\d*$/, "Invalid rate"),
  fixedRateExpiry: z.string().optional(),
  repaymentAmount: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
  repaymentFrequency: z.enum(["weekly", "fortnightly", "monthly"]),
  offsetAccountId: z.string().uuid().optional(),
});

export const loanRouter = router({
  list: protectedProcedure
    .input(z.object({ propertyId: z.string().uuid().optional() }).optional())
    .query(async ({ ctx, input }) => {
      const conditions = [eq(loans.userId, ctx.user.id)];

      if (input?.propertyId) {
        conditions.push(eq(loans.propertyId, input.propertyId));
      }

      return ctx.db.query.loans.findMany({
        where: and(...conditions),
        with: {
          property: true,
          offsetAccount: true,
        },
        orderBy: (loans, { desc }) => [desc(loans.createdAt)],
      });
    }),

  get: protectedProcedure
    .input(z.object({ id: z.string().uuid() }))
    .query(async ({ ctx, input }) => {
      const loan = await ctx.db.query.loans.findFirst({
        where: and(eq(loans.id, input.id), eq(loans.userId, ctx.user.id)),
        with: {
          property: true,
          offsetAccount: true,
        },
      });

      if (!loan) {
        throw new Error("Loan not found");
      }

      return loan;
    }),

  create: protectedProcedure.input(loanSchema).mutation(async ({ ctx, input }) => {
    const [loan] = await ctx.db
      .insert(loans)
      .values({
        userId: ctx.user.id,
        propertyId: input.propertyId,
        lender: input.lender,
        accountNumberMasked: input.accountNumberMasked,
        loanType: input.loanType,
        rateType: input.rateType,
        originalAmount: input.originalAmount,
        currentBalance: input.currentBalance,
        interestRate: input.interestRate,
        fixedRateExpiry: input.fixedRateExpiry || null,
        repaymentAmount: input.repaymentAmount,
        repaymentFrequency: input.repaymentFrequency,
        offsetAccountId: input.offsetAccountId || null,
      })
      .returning();

    return loan;
  }),

  update: protectedProcedure
    .input(z.object({ id: z.string().uuid() }).merge(loanSchema.partial()))
    .mutation(async ({ ctx, input }) => {
      const { id, ...data } = input;

      const [loan] = await ctx.db
        .update(loans)
        .set({
          ...data,
          updatedAt: new Date(),
        })
        .where(and(eq(loans.id, id), eq(loans.userId, ctx.user.id)))
        .returning();

      return loan;
    }),

  delete: protectedProcedure
    .input(z.object({ id: z.string().uuid() }))
    .mutation(async ({ ctx, input }) => {
      await ctx.db
        .delete(loans)
        .where(and(eq(loans.id, input.id), eq(loans.userId, ctx.user.id)));

      return { success: true };
    }),

  updateBalance: protectedProcedure
    .input(
      z.object({
        id: z.string().uuid(),
        currentBalance: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const [loan] = await ctx.db
        .update(loans)
        .set({
          currentBalance: input.currentBalance,
          updatedAt: new Date(),
        })
        .where(and(eq(loans.id, input.id), eq(loans.userId, ctx.user.id)))
        .returning();

      return loan;
    }),
});
```

**Step 2: Add to app router**

In `src/server/routers/_app.ts`:

```typescript
import { loanRouter } from "./loan";

export const appRouter = router({
  property: propertyRouter,
  transaction: transactionRouter,
  banking: bankingRouter,
  stats: statsRouter,
  loan: loanRouter,
});
```

**Step 3: Commit**

```bash
git add src/server/routers/loan.ts src/server/routers/_app.ts
git commit -m "feat: add loan router with CRUD operations"
```

---

### Task 9: Loans Module - UI Pages

**Files:**
- Create: `src/app/(dashboard)/loans/page.tsx`
- Create: `src/app/(dashboard)/loans/new/page.tsx`
- Create: `src/components/loans/LoanCard.tsx`
- Create: `src/components/loans/LoanForm.tsx`
- Modify: `src/components/layout/Sidebar.tsx`

**Step 1: Create LoanCard component**

Create `src/components/loans/LoanCard.tsx`:

```typescript
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Pencil, Trash2, Landmark } from "lucide-react";
import { format } from "date-fns";

interface LoanCardProps {
  loan: {
    id: string;
    lender: string;
    loanType: string;
    rateType: string;
    currentBalance: string;
    interestRate: string;
    repaymentAmount: string;
    repaymentFrequency: string;
    fixedRateExpiry: string | null;
    property: { address: string; suburb: string } | null;
  };
  onEdit: (id: string) => void;
  onDelete: (id: string) => void;
}

export function LoanCard({ loan, onEdit, onDelete }: LoanCardProps) {
  const formatCurrency = (amount: string) => {
    return new Intl.NumberFormat("en-AU", {
      style: "currency",
      currency: "AUD",
    }).format(parseFloat(amount));
  };

  const formatLoanType = (type: string) => {
    return type === "principal_and_interest" ? "P&I" : "Interest Only";
  };

  const formatRateType = (type: string) => {
    return type.charAt(0).toUpperCase() + type.slice(1);
  };

  return (
    <Card>
      <CardHeader className="flex flex-row items-start justify-between pb-2">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
            <Landmark className="w-5 h-5 text-primary" />
          </div>
          <div>
            <CardTitle className="text-base">{loan.lender}</CardTitle>
            <p className="text-sm text-muted-foreground">
              {loan.property?.address}, {loan.property?.suburb}
            </p>
          </div>
        </div>
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreHorizontal className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => onEdit(loan.id)}>
              <Pencil className="w-4 h-4 mr-2" />
              Edit
            </DropdownMenuItem>
            <DropdownMenuItem
              onClick={() => onDelete(loan.id)}
              className="text-destructive"
            >
              <Trash2 className="w-4 h-4 mr-2" />
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          <div className="flex items-center gap-2">
            <Badge variant="secondary">{formatLoanType(loan.loanType)}</Badge>
            <Badge variant="outline">{formatRateType(loan.rateType)}</Badge>
          </div>

          <div className="grid grid-cols-2 gap-3 text-sm">
            <div>
              <span className="text-muted-foreground">Balance</span>
              <p className="font-semibold">{formatCurrency(loan.currentBalance)}</p>
            </div>
            <div>
              <span className="text-muted-foreground">Interest Rate</span>
              <p className="font-semibold">{loan.interestRate}%</p>
            </div>
            <div>
              <span className="text-muted-foreground">Repayment</span>
              <p className="font-semibold">
                {formatCurrency(loan.repaymentAmount)}/{loan.repaymentFrequency}
              </p>
            </div>
            {loan.fixedRateExpiry && (
              <div>
                <span className="text-muted-foreground">Fixed Until</span>
                <p className="font-semibold">
                  {format(new Date(loan.fixedRateExpiry), "dd MMM yyyy")}
                </p>
              </div>
            )}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Step 2: Create LoanForm component**

Create `src/components/loans/LoanForm.tsx`:

```typescript
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { trpc } from "@/lib/trpc/client";

const loanFormSchema = z.object({
  propertyId: z.string().uuid("Please select a property"),
  lender: z.string().min(1, "Lender is required"),
  accountNumberMasked: z.string().optional(),
  loanType: z.enum(["principal_and_interest", "interest_only"]),
  rateType: z.enum(["variable", "fixed", "split"]),
  originalAmount: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
  currentBalance: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
  interestRate: z.string().regex(/^\d+\.?\d*$/, "Invalid rate"),
  fixedRateExpiry: z.string().optional(),
  repaymentAmount: z.string().regex(/^\d+\.?\d*$/, "Invalid amount"),
  repaymentFrequency: z.enum(["weekly", "fortnightly", "monthly"]),
});

export type LoanFormValues = z.infer<typeof loanFormSchema>;

interface LoanFormProps {
  defaultValues?: Partial<LoanFormValues>;
  onSubmit: (values: LoanFormValues) => void;
  isLoading?: boolean;
}

export function LoanForm({ defaultValues, onSubmit, isLoading }: LoanFormProps) {
  const { data: properties } = trpc.property.list.useQuery();

  const form = useForm<LoanFormValues>({
    resolver: zodResolver(loanFormSchema),
    defaultValues: {
      propertyId: "",
      lender: "",
      accountNumberMasked: "",
      loanType: "principal_and_interest",
      rateType: "variable",
      originalAmount: "",
      currentBalance: "",
      interestRate: "",
      fixedRateExpiry: "",
      repaymentAmount: "",
      repaymentFrequency: "monthly",
      ...defaultValues,
    },
  });

  const rateType = form.watch("rateType");

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <FormField
          control={form.control}
          name="propertyId"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Property</FormLabel>
              <Select onValueChange={field.onChange} defaultValue={field.value}>
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="Select property" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  {properties?.map((property) => (
                    <SelectItem key={property.id} value={property.id}>
                      {property.address}, {property.suburb}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />

        <div className="grid grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="lender"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Lender</FormLabel>
                <FormControl>
                  <Input placeholder="Commonwealth Bank" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="accountNumberMasked"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Account Number (optional)</FormLabel>
                <FormControl>
                  <Input placeholder="****1234" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="loanType"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Loan Type</FormLabel>
                <Select onValueChange={field.onChange} defaultValue={field.value}>
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="principal_and_interest">
                      Principal & Interest
                    </SelectItem>
                    <SelectItem value="interest_only">Interest Only</SelectItem>
                  </SelectContent>
                </Select>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="rateType"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Rate Type</FormLabel>
                <Select onValueChange={field.onChange} defaultValue={field.value}>
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="variable">Variable</SelectItem>
                    <SelectItem value="fixed">Fixed</SelectItem>
                    <SelectItem value="split">Split</SelectItem>
                  </SelectContent>
                </Select>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="originalAmount"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Original Loan Amount ($)</FormLabel>
                <FormControl>
                  <Input type="number" placeholder="500000" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="currentBalance"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Current Balance ($)</FormLabel>
                <FormControl>
                  <Input type="number" placeholder="450000" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="interestRate"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Interest Rate (%)</FormLabel>
                <FormControl>
                  <Input type="number" step="0.01" placeholder="6.5" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          {(rateType === "fixed" || rateType === "split") && (
            <FormField
              control={form.control}
              name="fixedRateExpiry"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Fixed Rate Expiry</FormLabel>
                  <FormControl>
                    <Input type="date" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          )}
        </div>

        <div className="grid grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="repaymentAmount"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Repayment Amount ($)</FormLabel>
                <FormControl>
                  <Input type="number" placeholder="2500" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="repaymentFrequency"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Repayment Frequency</FormLabel>
                <Select onValueChange={field.onChange} defaultValue={field.value}>
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    <SelectItem value="weekly">Weekly</SelectItem>
                    <SelectItem value="fortnightly">Fortnightly</SelectItem>
                    <SelectItem value="monthly">Monthly</SelectItem>
                  </SelectContent>
                </Select>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        <Button type="submit" disabled={isLoading}>
          {isLoading ? "Saving..." : "Save Loan"}
        </Button>
      </form>
    </Form>
  );
}
```

**Step 3: Create loans list page**

Create `src/app/(dashboard)/loans/page.tsx`:

```typescript
"use client";

import Link from "next/link";
import { Button } from "@/components/ui/button";
import { LoanCard } from "@/components/loans/LoanCard";
import { trpc } from "@/lib/trpc/client";
import { Plus, Landmark } from "lucide-react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";

export default function LoansPage() {
  const router = useRouter();
  const { data: loans, isLoading, refetch } = trpc.loan.list.useQuery();
  const deleteLoan = trpc.loan.delete.useMutation({
    onSuccess: () => {
      toast.success("Loan deleted");
      refetch();
    },
    onError: (error) => {
      toast.error(error.message || "Failed to delete loan");
    },
  });

  const handleDelete = (id: string) => {
    if (confirm("Are you sure you want to delete this loan?")) {
      deleteLoan.mutate({ id });
    }
  };

  const handleEdit = (id: string) => {
    router.push(`/loans/${id}/edit`);
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold">Loans</h2>
            <p className="text-muted-foreground">Manage your investment property loans</p>
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {[1, 2].map((i) => (
            <div key={i} className="h-48 rounded-lg bg-muted animate-pulse" />
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">Loans</h2>
          <p className="text-muted-foreground">Manage your investment property loans</p>
        </div>
        <Button asChild>
          <Link href="/loans/new">
            <Plus className="w-4 h-4 mr-2" />
            Add Loan
          </Link>
        </Button>
      </div>

      {loans && loans.length > 0 ? (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {loans.map((loan) => (
            <LoanCard
              key={loan.id}
              loan={loan}
              onEdit={handleEdit}
              onDelete={handleDelete}
            />
          ))}
        </div>
      ) : (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4">
            <Landmark className="w-8 h-8 text-primary" />
          </div>
          <h3 className="text-lg font-semibold">No loans yet</h3>
          <p className="text-muted-foreground max-w-sm mt-2">
            Add your investment property loans to track interest and repayments.
          </p>
          <Button asChild className="mt-4">
            <Link href="/loans/new">
              <Plus className="w-4 h-4 mr-2" />
              Add Your First Loan
            </Link>
          </Button>
        </div>
      )}
    </div>
  );
}
```

**Step 4: Create new loan page**

Create `src/app/(dashboard)/loans/new/page.tsx`:

```typescript
"use client";

import { useRouter } from "next/navigation";
import { LoanForm, LoanFormValues } from "@/components/loans/LoanForm";
import { trpc } from "@/lib/trpc/client";
import { toast } from "sonner";

export default function NewLoanPage() {
  const router = useRouter();
  const createLoan = trpc.loan.create.useMutation({
    onSuccess: () => {
      toast.success("Loan added successfully");
      router.push("/loans");
    },
    onError: (error) => {
      toast.error(error.message || "Failed to add loan");
    },
  });

  const handleSubmit = (values: LoanFormValues) => {
    createLoan.mutate(values);
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold">Add Loan</h2>
        <p className="text-muted-foreground">
          Add a loan for one of your investment properties
        </p>
      </div>

      <div className="max-w-2xl">
        <LoanForm onSubmit={handleSubmit} isLoading={createLoan.isPending} />
      </div>
    </div>
  );
}
```

**Step 5: Add loans to sidebar navigation**

In `src/components/layout/Sidebar.tsx`, add Landmark import and nav item:

```typescript
import { Landmark } from "lucide-react";

// Add to navItems array:
{ href: "/loans", label: "Loans", icon: Landmark },
```

**Step 6: Commit**

```bash
git add src/app/\(dashboard\)/loans src/components/loans src/components/layout/Sidebar.tsx
git commit -m "feat: add loans module with list and create pages"
```

---

### Task 10: CSV Transaction Import - Router

**Files:**
- Create: `src/server/services/csv-import.ts`
- Modify: `src/server/routers/transaction.ts`

**Step 1: Create CSV import service**

Create `src/server/services/csv-import.ts`:

```typescript
import { z } from "zod";

export const csvRowSchema = z.object({
  date: z.string(),
  description: z.string(),
  amount: z.string(),
  category: z.string().optional(),
});

export type CSVRow = z.infer<typeof csvRowSchema>;

export function parseCSV(csvContent: string): CSVRow[] {
  const lines = csvContent.trim().split("\n");
  if (lines.length < 2) {
    throw new Error("CSV must have at least a header row and one data row");
  }

  const headerLine = lines[0];
  const headers = headerLine.split(",").map((h) => h.trim().toLowerCase().replace(/"/g, ""));

  // Find column indices
  const dateIdx = headers.findIndex((h) =>
    ["date", "transaction date", "trans date"].includes(h)
  );
  const descIdx = headers.findIndex((h) =>
    ["description", "desc", "narrative", "details", "memo"].includes(h)
  );
  const amountIdx = headers.findIndex((h) =>
    ["amount", "value", "debit/credit"].includes(h)
  );
  const debitIdx = headers.findIndex((h) => ["debit", "withdrawal"].includes(h));
  const creditIdx = headers.findIndex((h) => ["credit", "deposit"].includes(h));

  if (dateIdx === -1) throw new Error("Could not find date column");
  if (descIdx === -1) throw new Error("Could not find description column");
  if (amountIdx === -1 && (debitIdx === -1 || creditIdx === -1)) {
    throw new Error("Could not find amount column(s)");
  }

  const rows: CSVRow[] = [];

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    // Simple CSV parsing (handles quoted fields with commas)
    const values: string[] = [];
    let current = "";
    let inQuotes = false;

    for (const char of line) {
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        values.push(current.trim());
        current = "";
      } else {
        current += char;
      }
    }
    values.push(current.trim());

    const date = values[dateIdx]?.replace(/"/g, "");
    const description = values[descIdx]?.replace(/"/g, "");

    let amount: string;
    if (amountIdx !== -1) {
      amount = values[amountIdx]?.replace(/"/g, "").replace(/[$,]/g, "");
    } else {
      const debit = parseFloat(values[debitIdx]?.replace(/"/g, "").replace(/[$,]/g, "") || "0");
      const credit = parseFloat(values[creditIdx]?.replace(/"/g, "").replace(/[$,]/g, "") || "0");
      amount = (credit - debit).toString();
    }

    if (date && description && amount) {
      rows.push({
        date: normalizeDate(date),
        description,
        amount,
      });
    }
  }

  return rows;
}

function normalizeDate(dateStr: string): string {
  // Handle various date formats
  const patterns = [
    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // DD/MM/YYYY or MM/DD/YYYY
    /^(\d{4})-(\d{2})-(\d{2})$/, // YYYY-MM-DD
    /^(\d{1,2})-(\d{1,2})-(\d{4})$/, // DD-MM-YYYY
  ];

  for (const pattern of patterns) {
    const match = dateStr.match(pattern);
    if (match) {
      if (pattern === patterns[1]) {
        // Already YYYY-MM-DD
        return dateStr;
      }
      // Assume DD/MM/YYYY for Australian format
      const [, day, month, year] = match;
      return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
    }
  }

  throw new Error(`Could not parse date: ${dateStr}`);
}
```

**Step 2: Add import mutation to transaction router**

Add to `src/server/routers/transaction.ts`:

```typescript
import { parseCSV } from "../services/csv-import";

// Add after the delete mutation:
  importCSV: protectedProcedure
    .input(
      z.object({
        propertyId: z.string().uuid(),
        csvContent: z.string(),
      })
    )
    .mutation(async ({ ctx, input }) => {
      const rows = parseCSV(input.csvContent);

      const imported: string[] = [];
      const errors: string[] = [];

      for (const row of rows) {
        try {
          const [transaction] = await ctx.db
            .insert(transactions)
            .values({
              userId: ctx.user.id,
              propertyId: input.propertyId,
              date: row.date,
              description: row.description,
              amount: row.amount,
              category: "uncategorized",
              transactionType: parseFloat(row.amount) >= 0 ? "income" : "expense",
              isDeductible: false,
            })
            .returning();

          imported.push(transaction.id);
        } catch (error) {
          errors.push(`Row ${row.date} ${row.description}: ${error}`);
        }
      }

      return {
        importedCount: imported.length,
        errorCount: errors.length,
        errors: errors.slice(0, 5), // Return first 5 errors
      };
    }),
```

**Step 3: Commit**

```bash
git add src/server/services/csv-import.ts src/server/routers/transaction.ts
git commit -m "feat: add CSV import service and router"
```

---

### Task 11: CSV Transaction Import - UI

**Files:**
- Create: `src/components/transactions/ImportCSVDialog.tsx`
- Modify: `src/app/(dashboard)/transactions/page.tsx`

**Step 1: Create import dialog**

Create `src/components/transactions/ImportCSVDialog.tsx`:

```typescript
"use client";

import { useState, useRef } from "react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogDescription,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { trpc } from "@/lib/trpc/client";
import { toast } from "sonner";
import { Upload, FileSpreadsheet } from "lucide-react";

interface ImportCSVDialogProps {
  onSuccess?: () => void;
}

export function ImportCSVDialog({ onSuccess }: ImportCSVDialogProps) {
  const [open, setOpen] = useState(false);
  const [propertyId, setPropertyId] = useState("");
  const [file, setFile] = useState<File | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const { data: properties } = trpc.property.list.useQuery();
  const importCSV = trpc.transaction.importCSV.useMutation({
    onSuccess: (result) => {
      toast.success(
        `Imported ${result.importedCount} transactions${
          result.errorCount > 0 ? ` (${result.errorCount} errors)` : ""
        }`
      );
      setOpen(false);
      setFile(null);
      setPropertyId("");
      onSuccess?.();
    },
    onError: (error) => {
      toast.error(error.message || "Failed to import CSV");
    },
  });

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (selectedFile) {
      setFile(selectedFile);
    }
  };

  const handleImport = async () => {
    if (!file || !propertyId) return;

    const csvContent = await file.text();
    importCSV.mutate({ propertyId, csvContent });
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button variant="outline">
          <Upload className="w-4 h-4 mr-2" />
          Import CSV
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Import Transactions from CSV</DialogTitle>
          <DialogDescription>
            Upload a CSV file from your bank statement to import transactions.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <label className="text-sm font-medium">Property</label>
            <Select value={propertyId} onValueChange={setPropertyId}>
              <SelectTrigger className="mt-1">
                <SelectValue placeholder="Select property" />
              </SelectTrigger>
              <SelectContent>
                {properties?.map((property) => (
                  <SelectItem key={property.id} value={property.id}>
                    {property.address}, {property.suburb}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div>
            <label className="text-sm font-medium">CSV File</label>
            <div
              className="mt-1 border-2 border-dashed rounded-lg p-6 text-center cursor-pointer hover:border-primary transition-colors"
              onClick={() => fileInputRef.current?.click()}
            >
              <input
                ref={fileInputRef}
                type="file"
                accept=".csv"
                onChange={handleFileChange}
                className="hidden"
              />
              {file ? (
                <div className="flex items-center justify-center gap-2">
                  <FileSpreadsheet className="w-5 h-5 text-primary" />
                  <span className="text-sm">{file.name}</span>
                </div>
              ) : (
                <>
                  <Upload className="w-8 h-8 mx-auto text-muted-foreground mb-2" />
                  <p className="text-sm text-muted-foreground">
                    Click to select a CSV file
                  </p>
                </>
              )}
            </div>
          </div>

          <div className="text-xs text-muted-foreground">
            <p className="font-medium mb-1">Expected columns:</p>
            <p>Date, Description, Amount (or Debit/Credit)</p>
          </div>

          <Button
            onClick={handleImport}
            disabled={!file || !propertyId || importCSV.isPending}
            className="w-full"
          >
            {importCSV.isPending ? "Importing..." : "Import Transactions"}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

**Step 2: Add to transactions page**

In `src/app/(dashboard)/transactions/page.tsx`, add import and button:

```typescript
import { ImportCSVDialog } from "@/components/transactions/ImportCSVDialog";

// In the header div, add next to AddTransactionDialog:
<div className="flex items-center gap-2">
  <ImportCSVDialog onSuccess={() => refetch()} />
  <AddTransactionDialog onSuccess={() => refetch()} />
</div>
```

**Step 3: Commit**

```bash
git add src/components/transactions/ImportCSVDialog.tsx src/app/\(dashboard\)/transactions/page.tsx
git commit -m "feat: add CSV import dialog for transactions"
```

---

### Task 12: Run All E2E Tests

**Step 1: Run tests to verify nothing is broken**

Run: `npx playwright test`
Expected: All tests pass

**Step 2: Commit any test fixes if needed**

---

### Task 13: Push Changes

**Step 1: Push all changes**

```bash
git push origin main
```

---

## Summary

**V0.1 Polish (Tasks 1-6):**
- Property edit page
- Manual transaction creation (schema + router + UI)
- Dashboard stats wired to real data

**V0.5 Features (Tasks 7-11):**
- Loans module (schema + router + UI pages)
- CSV import for transactions

**Total Tasks:** 13
**Estimated Commits:** 12

**Prerequisites:**
- Existing v0.1 codebase
- Database running
- Environment variables configured

---

Plan complete and saved to `docs/plans/2026-01-24-v0.1-polish-and-v0.5-features.md`.

**Two execution options:**

**1. Subagent-Driven (this session)** - I dispatch fresh subagent per task, review between tasks, fast iteration

**2. Parallel Session (separate)** - Open new session in worktree with executing-plans, batch execution with checkpoints

**Which approach?**
