# Wave 3.3 â€” Transaction Services Restructure Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Move all transaction-related services into `services/transaction/`, extract business logic from the router, move notes CRUD to the repository, and fix anti-patterns in every touched file.

**Architecture:** Flat directory structure mirroring `services/banking/`. Extract pure business logic from router into service functions. Move direct DB calls (notes CRUD) into `TransactionRepository`. Barrel re-exports all public API.

**Tech Stack:** tRPC v11, Drizzle ORM, Zod v4, Vitest

**Design doc:** `docs/plans/2026-02-15-wave-3.3-transaction-services-design.md`

---

## Tech Notes

- **Drizzle ORM:** Use `$inferSelect` / `$inferInsert` for typed repo methods. Relational queries with `with: {}` return fully typed results â€” no `as any` needed.
- **tRPC v11:** Routers should be thin controllers. Business logic belongs in services, data access in repositories.
- **Barrel pattern:** Follow `services/banking/index.ts` exactly â€” named re-exports, no `export *`.
- **Anti-patterns to fix during move:** `as any` casts in mytax.ts (4), type assertions in audit-checks.ts (4), tax-forecast.ts (2), yoy-comparison.ts (2), generic `any` in portfolio.ts (1).

---

## Task 1: Create worktree and directory structure

**Files:**
- Create: `~/worktrees/property-tracker/wave-3.3/` (worktree)
- Create: `src/server/services/transaction/` (directory)
- Create: `src/server/services/transaction/__tests__/` (directory)
- Create: `src/server/services/transaction/index.ts` (empty barrel)

**Step 1: Create worktree**
```bash
git worktree add ~/worktrees/property-tracker/wave-3.3 -b refactor/wave-3.3-transaction-services develop
cp ~/Documents/property-tracker/.env.local ~/worktrees/property-tracker/wave-3.3/.env.local
cd ~/worktrees/property-tracker/wave-3.3
```

**Step 2: Create directory structure**
```bash
mkdir -p src/server/services/transaction/__tests__
```

**Step 3: Create empty barrel**

Create `src/server/services/transaction/index.ts`:
```typescript
// Transaction services barrel â€” populated as files are moved
```

**Step 4: Commit**
```bash
git add src/server/services/transaction/
git commit -m "refactor: scaffold services/transaction/ directory"
```

---

## Task 2: Extract category logic from router

**Files:**
- Create: `src/server/services/transaction/category.ts`
- Modify: `src/server/routers/transaction.ts` (remove lines 11-72, add import)
- Modify: `src/server/services/transaction/index.ts` (add re-export)

**Step 1: Create `category.ts`**

Create `src/server/services/transaction/category.ts`:
```typescript
/** Transaction category constants and derivation logic */

export const categoryValues = [
  "rental_income",
  "other_rental_income",
  "advertising",
  "body_corporate",
  "borrowing_expenses",
  "cleaning",
  "council_rates",
  "gardening",
  "insurance",
  "interest_on_loans",
  "land_tax",
  "legal_expenses",
  "pest_control",
  "property_agent_fees",
  "repairs_and_maintenance",
  "capital_works_deductions",
  "stationery_and_postage",
  "travel_expenses",
  "water_charges",
  "sundry_rental_expenses",
  "stamp_duty",
  "conveyancing",
  "buyers_agent_fees",
  "initial_repairs",
  "transfer",
  "personal",
  "uncategorized",
] as const;

export type TransactionCategory = (typeof categoryValues)[number];

export type TransactionType = "income" | "expense" | "capital" | "transfer" | "personal";

const incomeCategories: readonly TransactionCategory[] = ["rental_income", "other_rental_income"];
const capitalCategories: readonly TransactionCategory[] = [
  "stamp_duty",
  "conveyancing",
  "buyers_agent_fees",
  "initial_repairs",
];
const nonDeductibleCategories: readonly string[] = [
  ...capitalCategories,
  "transfer",
  "personal",
  "uncategorized",
];

/** Derive transaction type and deductibility from a category */
export function deriveTransactionFields(category: string): {
  transactionType: TransactionType;
  isDeductible: boolean;
} {
  let transactionType: TransactionType = "expense";
  if (incomeCategories.includes(category as TransactionCategory)) {
    transactionType = "income";
  } else if (capitalCategories.includes(category as TransactionCategory)) {
    transactionType = "capital";
  } else if (category === "transfer") {
    transactionType = "transfer";
  } else if (category === "personal") {
    transactionType = "personal";
  }

  const isDeductible = !nonDeductibleCategories.includes(category);

  return { transactionType, isDeductible };
}
```

**Step 2: Update transaction router**

In `src/server/routers/transaction.ts`:
- Remove lines 11-72 (the `categoryValues` const and `deriveTransactionFields` function)
- Add import: `import { categoryValues, deriveTransactionFields } from "../services/transaction";`

**Step 3: Update barrel**

In `src/server/services/transaction/index.ts`:
```typescript
export {
  categoryValues,
  deriveTransactionFields,
  type TransactionCategory,
  type TransactionType,
} from "./category";
```

**Step 4: Run type check**
```bash
npx tsc --noEmit
```

**Step 5: Commit**
```bash
git add -A && git commit -m "refactor: extract category logic from transaction router"
```

---

## Task 3: Move `recurring.ts` + test (clean â€” no anti-patterns)

**Files:**
- Move: `src/server/services/recurring.ts` â†’ `src/server/services/transaction/recurring.ts`
- Move: `src/server/services/__tests__/recurring.test.ts` â†’ `src/server/services/transaction/__tests__/recurring.test.ts`
- Modify: 3 consumers (update import paths)
- Modify: `src/server/services/transaction/index.ts`

**Step 1: Move files**
```bash
git mv src/server/services/recurring.ts src/server/services/transaction/recurring.ts
git mv src/server/services/__tests__/recurring.test.ts src/server/services/transaction/__tests__/recurring.test.ts
```

**Step 2: Update internal imports in moved file**

In `src/server/services/transaction/recurring.ts`: No changes needed â€” imports are from `@/server/db/schema` and `@/lib/utils` (absolute paths, unaffected by move).

**Step 3: Update test imports**

In `src/server/services/transaction/__tests__/recurring.test.ts`: Update any relative import of the service from `../../recurring` â†’ `../recurring`.

**Step 4: Update consumers**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/recurring.ts` | `../services/recurring` | `../services/transaction` |
| `src/server/routers/cashFlowCalendar.ts` | `../services/recurring` | `../services/transaction` |
| `src/app/api/cron/generate-expected/route.ts` | `@/server/services/recurring` | `@/server/services/transaction` |

**Step 5: Add to barrel**

In `src/server/services/transaction/index.ts`, add:
```typescript
export {
  calculateNextDates,
  generateExpectedTransactions,
  findMatchingTransactions,
  findMissedTransactions,
  detectPatterns,
  type Frequency,
  type ExpectedStatus,
  type GeneratedExpectedTransaction,
  type MatchResult,
  type MatchCandidate,
  type PatternSuggestion,
} from "./recurring";
```

**Step 6: Run type check + tests**
```bash
npx tsc --noEmit && npx vitest run src/server/services/transaction/__tests__/recurring.test.ts
```

**Step 7: Commit**
```bash
git add -A && git commit -m "refactor: move recurring.ts to services/transaction/"
```

---

## Task 4: Move `reports.ts` + test (clean â€” no anti-patterns)

**Files:**
- Move: `src/server/services/reports.ts` â†’ `src/server/services/transaction/reports.ts`
- Move: `src/server/services/__tests__/reports.test.ts` â†’ `src/server/services/transaction/__tests__/reports.test.ts`
- Modify: 2 consumers + 4 internal dependents (tax-forecast, tax-optimization, yoy-comparison, audit-checks)
- Modify: barrel

**Step 1: Move files**
```bash
git mv src/server/services/reports.ts src/server/services/transaction/reports.ts
git mv src/server/services/__tests__/reports.test.ts src/server/services/transaction/__tests__/reports.test.ts
```

**Step 2: Update internal imports in files that depend on reports**

These files still live at `src/server/services/` and import `./reports`. After move they need `./transaction/reports` â€” BUT they will also be moved later. **Strategy:** Move reports first, temporarily break internal imports, then fix as each dependent file moves. Since they'll all end up in `services/transaction/`, the final import will be `./reports` again.

**Alternative (better):** Move reports.ts but DON'T update internal consumer imports yet â€” they'll be fixed when those files are moved in subsequent tasks. Just update the external consumers (routers).

**Step 3: Update external consumers**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/reports.ts` | `../services/reports` | `../services/transaction` |
| `src/server/routers/taxPosition.ts` | `../services/reports` | `../services/transaction` |

**Step 4: Update test imports**

In `src/server/services/transaction/__tests__/reports.test.ts`: Update relative imports from `../../reports` â†’ `../reports`.

**Step 5: Add to barrel**
```typescript
export {
  getFinancialYearRange,
  calculateCategoryTotals,
  calculatePropertyMetrics,
  getFinancialYearTransactions,
  getPropertiesWithLoans,
  type TransactionInput,
  type FinancialYearRange,
  type PropertyMetrics,
  type CategoryTotal,
} from "./reports";
```

**Step 6: Run type check**
```bash
npx tsc --noEmit
```
Expected: May have errors from unmoved files (tax-forecast, etc.) importing `./reports`. This is OK â€” will be fixed as those files move.

**Step 7: Commit**
```bash
git add -A && git commit -m "refactor: move reports.ts to services/transaction/"
```

---

## Task 5: Move `tax-forecast.ts` + test + fix anti-patterns

**Files:**
- Move: `src/server/services/tax-forecast.ts` â†’ `src/server/services/transaction/tax-forecast.ts`
- Move: `src/server/services/__tests__/tax-forecast.test.ts` â†’ `src/server/services/transaction/__tests__/tax-forecast.test.ts`
- Modify: 1 consumer
- Fix: 2 type assertion anti-patterns (lines ~184, ~188)

**Step 1: Move files**
```bash
git mv src/server/services/tax-forecast.ts src/server/services/transaction/tax-forecast.ts
git mv src/server/services/__tests__/tax-forecast.test.ts src/server/services/transaction/__tests__/tax-forecast.test.ts
```

**Step 2: Fix anti-patterns**

In `src/server/services/transaction/tax-forecast.ts`:
- Lines ~184, ~188: Replace `as Array<{ date: string; amount: string; ... }>` type assertions with proper Drizzle inferred types. The query result from `ctx.db.query.transactions.findMany()` is already typed â€” remove the `as` cast and let TypeScript infer.
- Update `./reports` import â†’ already correct (both files now in `transaction/`)
- Update `./tax-position` import â†’ `../tax-position` (tax-position stays in parent)

**Step 3: Update consumer**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/taxForecast.ts` | `../services/tax-forecast` | `../services/transaction` |

**Step 4: Update test + barrel, type check**
```bash
npx tsc --noEmit && npx vitest run src/server/services/transaction/__tests__/tax-forecast.test.ts
```

**Step 5: Commit**
```bash
git add -A && git commit -m "refactor: move tax-forecast.ts to services/transaction/ + fix type assertions"
```

---

## Task 6: Move `tax-optimization.ts` (clean)

**Files:**
- Move: `src/server/services/tax-optimization.ts` â†’ `src/server/services/transaction/tax-optimization.ts`
- Modify: 2 consumers
- Fix: Local `getCategoryLabel` should import from `@/lib/categories` instead of being redefined

**Step 1: Move file** (no test file exists)
```bash
git mv src/server/services/tax-optimization.ts src/server/services/transaction/tax-optimization.ts
```

**Step 2: Fix local getCategoryLabel duplication**

Remove the local `getCategoryLabel` function (lines ~325-335) and import from `@/lib/categories` instead.

**Step 3: Update consumers**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/taxOptimization.ts` | `../services/tax-optimization` | `../services/transaction` |
| `src/app/api/cron/tax-suggestions/route.ts` | `@/server/services/tax-optimization` | `@/server/services/transaction` |

**Step 4: Update internal import** `./reports` is now correct (same directory).

**Step 5: Barrel + type check + commit**
```bash
npx tsc --noEmit
git add -A && git commit -m "refactor: move tax-optimization.ts to services/transaction/"
```

---

## Task 7: Move `yoy-comparison.ts` + test + fix anti-patterns

**Files:**
- Move: `src/server/services/yoy-comparison.ts` â†’ `src/server/services/transaction/yoy-comparison.ts`
- Move: `src/server/services/__tests__/yoy-comparison.test.ts` â†’ `src/server/services/transaction/__tests__/yoy-comparison.test.ts`
- Modify: 1 consumer
- Fix: 2 type assertion anti-patterns (lines ~222, ~227)

**Step 1: Move + fix**
```bash
git mv src/server/services/yoy-comparison.ts src/server/services/transaction/yoy-comparison.ts
git mv src/server/services/__tests__/yoy-comparison.test.ts src/server/services/transaction/__tests__/yoy-comparison.test.ts
```

Replace `as Array<{ propertyId: string | null; category: string; amount: string }>` with proper Drizzle query result types.

**Step 2: Update consumer**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/yoyComparison.ts` | `../services/yoy-comparison` | `../services/transaction` |

**Step 3: Barrel + type check + test + commit**
```bash
npx tsc --noEmit && npx vitest run src/server/services/transaction/__tests__/yoy-comparison.test.ts
git add -A && git commit -m "refactor: move yoy-comparison.ts to services/transaction/ + fix type assertions"
```

---

## Task 8: Move `audit-checks.ts` + test + fix anti-patterns

**Files:**
- Move: `src/server/services/audit-checks.ts` â†’ `src/server/services/transaction/audit-checks.ts`
- Move: `src/server/services/__tests__/audit-checks.test.ts` â†’ `src/server/services/transaction/__tests__/audit-checks.test.ts`
- Modify: 1 consumer
- Fix: 4 anti-patterns (type assertions + `unknown` relation field)

**Step 1: Move + fix**
```bash
git mv src/server/services/audit-checks.ts src/server/services/transaction/audit-checks.ts
git mv src/server/services/__tests__/audit-checks.test.ts src/server/services/transaction/__tests__/audit-checks.test.ts
```

Fixes:
- Lines ~301-313: Remove `as Array<...>` type assertions â€” use Drizzle inferred types
- Line ~341: Replace `(prop as { loans?: unknown[] }).loans?.length ? true : false` with properly typed relation access

**Step 2: Consumer + barrel + type check + test + commit**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/auditChecks.ts` | `../services/audit-checks` | `../services/transaction` |

```bash
npx tsc --noEmit && npx vitest run src/server/services/transaction/__tests__/audit-checks.test.ts
git add -A && git commit -m "refactor: move audit-checks.ts to services/transaction/ + fix type safety"
```

---

## Task 9: Move `mytax.ts` + test + fix anti-patterns (most severe)

**Files:**
- Move: `src/server/services/mytax.ts` â†’ `src/server/services/transaction/mytax.ts`
- Move: `src/server/services/__tests__/mytax.test.ts` â†’ `src/server/services/transaction/__tests__/mytax.test.ts`
- Move: `src/server/services/__tests__/mytax-pdf.test.ts` â†’ `src/server/services/transaction/__tests__/mytax-pdf.test.ts`
- Modify: 3 consumers
- Fix: 4 `as any` anti-patterns

**Step 1: Move files**
```bash
git mv src/server/services/mytax.ts src/server/services/transaction/mytax.ts
git mv src/server/services/__tests__/mytax.test.ts src/server/services/transaction/__tests__/mytax.test.ts
git mv src/server/services/__tests__/mytax-pdf.test.ts src/server/services/transaction/__tests__/mytax-pdf.test.ts
```

**Step 2: Fix `as any` casts**

In `src/server/services/transaction/mytax.ts`:
- Line ~130: `(schedule as any).assets || []` â†’ Type the query result properly. The `with: { assets: true }` in the Drizzle query already returns typed `assets`. Access it directly without cast.
- Line ~151: `calculateCategoryTotals(propTxns as any)` â†’ Ensure `propTxns` matches `TransactionInput[]` type from reports.ts. If needed, map to the correct shape.
- Lines ~154-155: `buildLineItems(incomeCategories, catTotals, propTxns as any)` â†’ Same fix â€” proper typing.

**Step 3: Update consumers**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/mytax.ts` | `../services/mytax` | `../services/transaction` |
| `src/lib/mytax-pdf.ts` | `@/server/services/mytax` | `@/server/services/transaction` |
| `src/app/(dashboard)/reports/mytax/MyTaxChecklist.tsx` | `@/server/services/mytax` | `@/server/services/transaction` (type-only import) |

**Step 4: Barrel + type check + tests + commit**
```bash
npx tsc --noEmit && npx vitest run src/server/services/transaction/__tests__/mytax
git add -A && git commit -m "refactor: move mytax.ts to services/transaction/ + eliminate as-any casts"
```

---

## Task 10: Move `portfolio.ts` + test + fix anti-pattern

**Files:**
- Move: `src/server/services/portfolio.ts` â†’ `src/server/services/transaction/portfolio.ts`
- Move: `src/server/services/__tests__/portfolio.test.ts` â†’ `src/server/services/transaction/__tests__/portfolio.test.ts`
- Modify: 2 consumers
- Fix: 1 anti-pattern (generic `any` constraint)

**Step 1: Move + fix**
```bash
git mv src/server/services/portfolio.ts src/server/services/transaction/portfolio.ts
git mv src/server/services/__tests__/portfolio.test.ts src/server/services/transaction/__tests__/portfolio.test.ts
```

Fix line ~62: `findBestWorst<T extends Record<string, any>>` â†’ Replace with a more specific constraint like `T extends { id: string; [key: string]: string | number | boolean | null | undefined }` or use the actual types being passed.

**Step 2: Update consumers**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/server/routers/portfolio.ts` | `../services/portfolio` | `../services/transaction` |
| `src/server/routers/share.ts` | `../services/portfolio` | `../services/transaction` |

**Step 3: Barrel + type check + test + commit**
```bash
npx tsc --noEmit && npx vitest run src/server/services/transaction/__tests__/portfolio.test.ts
git add -A && git commit -m "refactor: move portfolio.ts to services/transaction/ + fix generic constraint"
```

---

## Task 11: Move `export.ts` + extract CSV export from router

**Files:**
- Move: `src/server/services/export.ts` â†’ `src/server/services/transaction/csv-export.ts`
- Modify: `src/server/routers/transaction.ts` (extract exportCSV formatting logic)
- Modify: `src/app/api/export/csv/route.ts` (update import)

**Step 1: Move and rename**
```bash
git mv src/server/services/export.ts src/server/services/transaction/csv-export.ts
```

**Step 2: Add `formatTransactionsCSV` function**

Extract the CSV formatting logic from `routers/transaction.ts` lines 103-133 into a new function in `csv-export.ts`:

```typescript
import { getCategoryLabel } from "@/lib/categories";

interface TransactionCSVRow {
  date: string;
  description: string;
  amount: string;
  category: string;
  transactionType: string;
  property: { address?: string } | null | undefined;
  isDeductible: boolean;
  isVerified: boolean;
  notes: string | null;
}

export function formatTransactionsCSV(results: TransactionCSVRow[]): {
  csv: string;
  filename: string;
} {
  const escapeCsv = (val: string) => {
    if (val.includes(",") || val.includes('"') || val.includes("\n")) {
      return `"${val.replace(/"/g, '""')}"`;
    }
    return val;
  };

  const header = "Date,Description,Amount,Category,Transaction Type,Property,Is Deductible,Is Verified,Notes";
  const rows = results.map((t) => [
    t.date,
    escapeCsv(t.description),
    t.amount,
    getCategoryLabel(t.category),
    t.transactionType,
    t.property?.address ?? "",
    t.isDeductible ? "Yes" : "No",
    t.isVerified ? "Yes" : "No",
    escapeCsv(t.notes ?? ""),
  ].join(","));

  const csv = [header, ...rows].join("\n");
  const today = new Date().toISOString().split("T")[0];
  const filename = `bricktrack-transactions-${today}.csv`;

  return { csv, filename };
}
```

**Step 3: Simplify router's exportCSV endpoint**

```typescript
exportCSV: protectedProcedure
  .input(/* same schema */)
  .query(async ({ ctx, input }) => {
    const results = await ctx.uow.transactions.findAllByOwner(ctx.portfolio.ownerId, input);
    return formatTransactionsCSV(results);
  }),
```

**Step 4: Update consumer + barrel + type check + commit**

| Consumer | Old import | New import |
|----------|-----------|------------|
| `src/app/api/export/csv/route.ts` | `@/server/services/export` | `@/server/services/transaction` |

```bash
npx tsc --noEmit
git add -A && git commit -m "refactor: move export.ts to services/transaction/csv-export + extract from router"
```

---

## Task 12: Extract import orchestration from router

**Files:**
- Create: `src/server/services/transaction/import.ts`
- Modify: `src/server/routers/transaction.ts` (simplify importCSV + importRichCSV)

**Step 1: Create `import.ts`**

Extract the loop + error collection pattern from both `importCSV` (lines 300-330) and `importRichCSV` (lines 332-382) into service functions:

```typescript
import type { ITransactionRepository } from "@/server/repositories/interfaces/transaction.repository.interface";

interface ImportResult {
  importedCount: number;
  errorCount: number;
  errors: string[];
}

interface ParsedCSVRow {
  date: string;
  description: string;
  amount: string;
}

interface RichCSVRow {
  date: string;
  description: string;
  amount: number;
  propertyId: string | null;
  category: string;
  transactionType: string;
  isDeductible: boolean;
  notes: string | null;
  invoiceUrl: string | null;
  invoicePresent: boolean;
}

export async function importCSVRows(
  repo: ITransactionRepository,
  userId: string,
  propertyId: string,
  rows: ParsedCSVRow[],
): Promise<ImportResult> {
  const imported: string[] = [];
  const errors: string[] = [];

  for (const row of rows) {
    try {
      const transaction = await repo.create({
        userId,
        propertyId,
        date: row.date,
        description: row.description,
        amount: row.amount,
        category: "uncategorized",
        transactionType: parseFloat(row.amount) >= 0 ? "income" : "expense",
        isDeductible: false,
      });
      imported.push(transaction.id);
    } catch (error) {
      errors.push(`Row ${row.date} ${row.description}: ${error}`);
    }
  }

  return {
    importedCount: imported.length,
    errorCount: errors.length,
    errors: errors.slice(0, 5),
  };
}

export async function importRichCSVRows(
  repo: ITransactionRepository,
  userId: string,
  rows: RichCSVRow[],
): Promise<ImportResult> {
  const imported: string[] = [];
  const errors: string[] = [];

  for (const row of rows) {
    try {
      const transaction = await repo.create({
        userId,
        propertyId: row.propertyId,
        date: row.date,
        description: row.description,
        amount: row.amount.toString(),
        category: row.category,
        transactionType: row.transactionType,
        isDeductible: row.isDeductible,
        notes: row.notes,
        invoiceUrl: row.invoiceUrl,
        invoicePresent: row.invoicePresent,
      });
      imported.push(transaction.id);
    } catch (error) {
      errors.push(`Row ${row.date} ${row.description}: ${error}`);
    }
  }

  return {
    importedCount: imported.length,
    errorCount: errors.length,
    errors: errors.slice(0, 5),
  };
}
```

**Step 2: Simplify router**

```typescript
importCSV: writeProcedure
  .input(z.object({ propertyId: z.string().uuid(), csvContent: z.string() }))
  .mutation(async ({ ctx, input }) => {
    const rows = parseCSV(input.csvContent);
    return importCSVRows(ctx.uow.transactions, ctx.portfolio.ownerId, input.propertyId, rows);
  }),

importRichCSV: writeProcedure
  .input(z.object({ rows: z.array(/* same schema */) }))
  .mutation(async ({ ctx, input }) => {
    return importRichCSVRows(ctx.uow.transactions, ctx.portfolio.ownerId, input.rows);
  }),
```

**Step 3: Barrel + type check + commit**
```bash
npx tsc --noEmit
git add -A && git commit -m "refactor: extract import orchestration from transaction router"
```

---

## Task 13: Move notes CRUD to repository

**Files:**
- Modify: `src/server/repositories/interfaces/transaction.repository.interface.ts` (add notes methods)
- Modify: `src/server/repositories/transaction.repository.ts` (implement notes methods)
- Modify: `src/server/routers/transaction.ts` (replace `ctx.db` with `ctx.uow.transactions`)

**Step 1: Add notes methods to interface**

In `src/server/repositories/interfaces/transaction.repository.interface.ts`, add:
```typescript
/** List discussion notes for a transaction */
listNotes(transactionId: string): Promise<TransactionNote[]>;

/** Add a discussion note to a transaction */
addNote(transactionId: string, userId: string, content: string): Promise<TransactionNote>;

/** Update a discussion note (user-scoped) */
updateNote(noteId: string, userId: string, content: string): Promise<TransactionNote | null>;

/** Delete a discussion note (user-scoped) */
deleteNote(noteId: string, userId: string): Promise<void>;
```

Where `TransactionNote` is the Drizzle inferred type from the `transactionNotes` schema.

**Step 2: Implement in repository**

In `src/server/repositories/transaction.repository.ts`, add the 4 methods using the same Drizzle queries currently in the router (lines 412-502), but as proper repository methods.

**Step 3: Update router**

Replace all direct `ctx.db` calls in the notes endpoints with `ctx.uow.transactions.listNotes()`, `.addNote()`, `.updateNote()`, `.deleteNote()`.

The router's notes section shrinks to:
```typescript
listNotes: protectedProcedure
  .input(z.object({ transactionId: z.string().uuid() }))
  .query(async ({ ctx, input }) => {
    const tx = await ctx.uow.transactions.findById(input.transactionId, ctx.portfolio.ownerId);
    if (!tx) throw new TRPCError({ code: "NOT_FOUND", message: "Transaction not found" });
    return ctx.uow.transactions.listNotes(input.transactionId);
  }),

addNote: writeProcedure
  .input(z.object({ transactionId: z.string().uuid(), content: z.string().min(1, "Note content is required") }))
  .mutation(async ({ ctx, input }) => {
    const tx = await ctx.uow.transactions.findById(input.transactionId, ctx.portfolio.ownerId);
    if (!tx) throw new TRPCError({ code: "NOT_FOUND", message: "Transaction not found" });
    return ctx.uow.transactions.addNote(input.transactionId, ctx.portfolio.ownerId, input.content);
  }),

updateNote: writeProcedure
  .input(z.object({ noteId: z.string().uuid(), content: z.string().min(1, "Note content is required") }))
  .mutation(async ({ ctx, input }) => {
    const note = await ctx.uow.transactions.updateNote(input.noteId, ctx.portfolio.ownerId, input.content);
    if (!note) throw new TRPCError({ code: "NOT_FOUND", message: "Note not found" });
    return note;
  }),

deleteNote: writeProcedure
  .input(z.object({ noteId: z.string().uuid() }))
  .mutation(async ({ ctx, input }) => {
    await ctx.uow.transactions.deleteNote(input.noteId, ctx.portfolio.ownerId);
    return { success: true };
  }),
```

**Step 4: Remove direct schema imports from router**

After this, the router should no longer import `transactionNotes`, `eq`, `and`, `desc` from drizzle â€” those are now in the repository.

**Step 5: Type check + commit**
```bash
npx tsc --noEmit
git add -A && git commit -m "refactor: move notes CRUD to TransactionRepository"
```

---

## Task 14: Finalize barrel + clean up router imports

**Files:**
- Modify: `src/server/services/transaction/index.ts` (ensure all exports present)
- Modify: `src/server/routers/transaction.ts` (verify clean imports)

**Step 1: Verify barrel has all exports**

The barrel should re-export from all 11 files: `category.ts`, `csv-export.ts`, `import.ts`, `recurring.ts`, `reports.ts`, `tax-forecast.ts`, `tax-optimization.ts`, `yoy-comparison.ts`, `audit-checks.ts`, `mytax.ts`, `portfolio.ts`.

**Step 2: Verify router is clean**

The transaction router should:
- Import `categoryValues`, `deriveTransactionFields`, `formatTransactionsCSV`, `importCSVRows`, `importRichCSVRows` from `../services/transaction`
- Import `parseCSV` from `../services/banking`
- Import `metrics` from `@/lib/metrics`
- Import `z` from `zod`, `TRPCError` from `@trpc/server`
- Import `router`, `protectedProcedure`, `writeProcedure` from `../trpc`
- **No** direct `transactionNotes` schema import
- **No** `eq`, `and`, `desc` from drizzle-orm (unless still needed for non-notes queries)
- **No** inline business logic

**Step 3: Commit**
```bash
npx tsc --noEmit
git add -A && git commit -m "refactor: finalize transaction services barrel + clean router imports"
```

---

## Task 15: Full verification

**Step 1: Type check**
```bash
npx tsc --noEmit
```

**Step 2: Lint**
```bash
npm run lint
```

**Step 3: Unit tests**
```bash
npx vitest run src/server/services/transaction/
```

**Step 4: Related router tests**
```bash
npx vitest run src/server/routers/__tests__/transaction.test.ts
npx vitest run src/server/routers/__tests__/reports.test.ts
npx vitest run src/server/routers/__tests__/mytax.test.ts
```

**Step 5: Full test suite**
```bash
npm run test:unit
```

**Step 6: Build check**
```bash
npm run build
```

**Step 7: Commit any lint fixes**
```bash
git add -A && git commit -m "fix: lint + type fixes from Wave 3.3 restructure"
```

---

## Task 16: Create PR

```bash
gh pr create --base develop --title "refactor: Wave 3.3 â€” restructure transaction services into services/transaction/" --body "$(cat <<'EOF'
## Summary
- Moved 9 transaction-related services into `services/transaction/` with barrel re-exports
- Extracted category derivation, CSV export, and import orchestration from transaction router into services
- Moved notes CRUD from direct `ctx.db` calls to `TransactionRepository`
- Fixed 13 anti-patterns: `as any` casts, type assertions, `unknown` relation types, generic constraints
- Transaction router is now a thin controller (~200 lines) with no business logic

## Files moved
- `recurring.ts`, `reports.ts`, `export.ts` â†’ `csv-export.ts`, `tax-forecast.ts`, `tax-optimization.ts`, `yoy-comparison.ts`, `audit-checks.ts`, `mytax.ts`, `portfolio.ts`
- All corresponding test files

## Files created
- `services/transaction/category.ts` â€” extracted from router
- `services/transaction/import.ts` â€” extracted from router
- `services/transaction/index.ts` â€” barrel

## Anti-patterns fixed
- 4x `as any` in mytax.ts
- 4x type assertions + `unknown` relation in audit-checks.ts
- 2x type assertions in tax-forecast.ts
- 2x type assertions in yoy-comparison.ts
- 1x generic `any` constraint in portfolio.ts

## Test plan
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run build` passes
- [ ] All moved test files pass in new locations

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

---

## Consumer Update Reference

Complete mapping of all import path changes:

| Consumer File | Old Import | New Import |
|--------------|-----------|------------|
| `src/server/routers/transaction.ts` | inline code | `../services/transaction` |
| `src/server/routers/recurring.ts` | `../services/recurring` | `../services/transaction` |
| `src/server/routers/cashFlowCalendar.ts` | `../services/recurring` | `../services/transaction` |
| `src/app/api/cron/generate-expected/route.ts` | `@/server/services/recurring` | `@/server/services/transaction` |
| `src/server/routers/reports.ts` | `../services/reports` | `../services/transaction` |
| `src/server/routers/taxPosition.ts` | `../services/reports` | `../services/transaction` |
| `src/server/routers/taxForecast.ts` | `../services/tax-forecast` | `../services/transaction` |
| `src/server/routers/taxOptimization.ts` | `../services/tax-optimization` | `../services/transaction` |
| `src/app/api/cron/tax-suggestions/route.ts` | `@/server/services/tax-optimization` | `@/server/services/transaction` |
| `src/server/routers/yoyComparison.ts` | `../services/yoy-comparison` | `../services/transaction` |
| `src/server/routers/auditChecks.ts` | `../services/audit-checks` | `../services/transaction` |
| `src/server/routers/mytax.ts` | `../services/mytax` | `../services/transaction` |
| `src/lib/mytax-pdf.ts` | `@/server/services/mytax` | `@/server/services/transaction` |
| `src/app/(dashboard)/reports/mytax/MyTaxChecklist.tsx` | `@/server/services/mytax` (type) | `@/server/services/transaction` (type) |
| `src/server/routers/portfolio.ts` | `../services/portfolio` | `../services/transaction` |
| `src/server/routers/share.ts` | `../services/portfolio` | `../services/transaction` |
| `src/app/api/export/csv/route.ts` | `@/server/services/export` | `@/server/services/transaction` |
