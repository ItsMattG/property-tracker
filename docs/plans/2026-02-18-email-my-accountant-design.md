# Email My Accountant — Design Document

**Date:** 2026-02-18
**Status:** Approved
**Feature Roadmap Task:** Task 7 (Wave B)

## Problem

Property investors need to share financial reports with their accountant each tax season. Currently, users can download PDFs manually but have no way to send a curated pack directly from BrickTrack. This creates friction — users must download, compose an email, attach files, and explain what's included.

## Solution

One-click accountant pack generation and email delivery. Users select a financial year, pick which report sections to include, preview the PDF, and send it directly to their connected accountant — all within BrickTrack.

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Accountant storage | Portfolio invite system (`portfolioMembers` with "accountant" role) | Already exists in schema, enables future accountant portal |
| Pack contents | Modular — user picks sections | Maximum flexibility, users know what their accountant needs |
| Delivery method | Email with PDF attachment (Resend) | Simple, accountant gets everything in one email |
| Plan gating | Pro+ only (free users can download but not email) | Drives upgrades during tax season |

## Architecture

### 1. Advisor Management — `/settings/advisors`

**Purpose:** Manage connected accountant via existing portfolio invite system.

**UI:**
- List connected advisors (filtered to "accountant" role from `portfolioMembers`)
- "Add Accountant" button opens invite dialog
- Invite fields: name, email
- Creates `portfolioInvites` record with role="accountant"
- Sends invite email via existing `inviteEmailTemplate()`
- Shows invite status: pending / accepted
- Can remove or change accountant
- Accountant does NOT need to create a BrickTrack account — invite stores their email for pack delivery

**Data:** Uses existing `portfolioInvites` + `portfolioMembers` tables. No schema changes needed.

### 2. Accountant Pack Page — `/reports/accountant-pack`

**Purpose:** Generate modular PDF pack and send to connected accountant.

**UI sections:**

**Header:** "Accountant Pack" with subtitle showing connected accountant name/email (or prompt to add one)

**Financial Year Selector:** Dropdown of available years (reuses `reports.getAvailableYears()`)

**Section Picker:** Toggle switches for each section:
- Income & Expenses (by ATO code)
- Depreciation Schedule (capital works + plant & equipment)
- Capital Gains Tax calculations
- Tax Position Summary (taxable income, refund/owing)
- Portfolio Overview (property summary, valuations)
- Loan Details (balances, interest, compliance)

Default: all tax-related sections ON, portfolio/loan sections OFF.

**Actions:**
- "Download Preview" — generates and downloads PDF locally
- "Email to Accountant" — Pro+ gated, sends via Resend
  - Confirmation dialog: "Send FY2025 accountant pack to jane@accounting.com.au?"
  - Success toast: "Sent to jane@accounting.com.au"
  - If no accountant connected: "Add an accountant in Settings > Advisors first"

**Send History:** Table showing previously sent packs (date, FY, recipient, sections included).

### 3. Accountant Pack PDF Generator

**File:** `src/lib/accountant-pack-pdf.ts`

**Input:**
```typescript
interface AccountantPackConfig {
  financialYear: number;
  userName: string;
  sections: {
    incomeExpenses: boolean;
    depreciation: boolean;
    capitalGains: boolean;
    taxPosition: boolean;
    portfolioOverview: boolean;
    loanDetails: boolean;
  };
  data: {
    taxReport?: TaxReportData;
    myTaxReport?: MyTaxReport;
    cgtData?: CapitalGainResult[];
    taxPosition?: TaxPositionResult;
    portfolioSnapshot?: PortfolioSnapshot;
    loanPackSnapshot?: LoanPackSnapshot;
  };
}
```

**Output:** `Blob` (PDF)

**Structure:**
1. **Cover page** — BrickTrack logo, user name, financial year, date generated, "Prepared for [Accountant Name]"
2. **Table of contents** — lists included sections with page numbers
3. **Each enabled section** — formatted as a chapter
4. **Footer** — "Generated by BrickTrack on [date]" on every page

**Reuses:** Formatting patterns from `mytax-pdf.ts` (ATO tables), `share-pdf.ts` (portfolio layout), `loan-pack-pdf.ts` (loan tables).

### 4. Email Template

**File:** `src/lib/email/templates/accountant-pack.ts`

**Extends:** `baseTemplate()` from `src/lib/email/templates/base.ts`

**Content:**
```
Subject: BrickTrack — FY[year] Property Investment Report from [User Name]

Body:
[User Name] has shared their FY[year] property investment report with you via BrickTrack.

Included sections:
- Income & Expenses
- Depreciation Schedule
- [etc.]

The full report is attached as a PDF.

If you have questions about this report, please contact [User Name] directly at [user email].
```

**Tone:** Professional, concise, suitable for accountant audience. No marketing, no upsell.

### 5. tRPC Router

**File:** `src/server/routers/analytics/accountantPack.ts`

**Procedures:**

| Procedure | Type | Gate | Purpose |
|-----------|------|------|---------|
| `generatePack` | `protectedProcedure` | Auth only | Assemble data, generate PDF, return as base64 for preview/download |
| `sendToAccountant` | `writeProcedure` | Pro+ plan | Generate PDF + send via Resend with attachment |
| `getSendHistory` | `protectedProcedure` | Auth only | Return list of previously sent packs |

**`generatePack` input:**
```typescript
z.object({
  financialYear: z.number(),
  sections: z.object({
    incomeExpenses: z.boolean(),
    depreciation: z.boolean(),
    capitalGains: z.boolean(),
    taxPosition: z.boolean(),
    portfolioOverview: z.boolean(),
    loanDetails: z.boolean(),
  }),
})
```

**`sendToAccountant` flow:**
1. Check Pro+ plan → throw `FORBIDDEN` if free
2. Find connected accountant from `portfolioMembers` (role="accountant") → throw if none
3. Aggregate data from existing services (parallel Promise.all)
4. Generate PDF via `accountant-pack-pdf.ts`
5. Build email via `accountant-pack.ts` template
6. Send via Resend with PDF attachment
7. Log to `accountantPackSends` table
8. Return success

### 6. Database Schema

**New table:** `accountantPackSends`

```typescript
export const accountantPackSends = pgTable("accountant_pack_sends", {
  id: uuid("id").defaultRandom().primaryKey(),
  userId: text("user_id").notNull().references(() => users.id),
  accountantEmail: text("accountant_email").notNull(),
  financialYear: integer("financial_year").notNull(),
  sections: jsonb("sections").notNull(), // record of enabled sections
  sentAt: timestamp("sent_at", { withTimezone: true }).defaultNow().notNull(),
});
```

### 7. Plan Gating

**In `src/server/services/billing/subscription.ts`:**

Add to `PLAN_LIMITS`:
```typescript
canEmailAccountant: false,  // free
canEmailAccountant: true,   // pro, team, lifetime
```

**UI:** Free users see the full page but "Email to Accountant" button shows upgrade prompt. "Download Preview" works for all plans.

### 8. Sidebar Navigation

Add to Reports nav group in `Sidebar.tsx`:
```typescript
{ href: "/reports/accountant-pack", label: "Accountant Pack", icon: Briefcase }
```

## Existing Code Reuse

| Component | File | How Used |
|-----------|------|----------|
| PDF generation | `src/lib/mytax-pdf.ts` | ATO code table formatting |
| PDF generation | `src/lib/share-pdf.ts` | Portfolio overview layout |
| PDF generation | `src/lib/loan-pack-pdf.ts` | Loan detail tables |
| Email sender | `src/server/services/notification/notification.ts` | `sendEmailNotification()` |
| Email templates | `src/lib/email/templates/base.ts` | `baseTemplate()` wrapper |
| Tax report data | `src/server/routers/analytics/reports.ts` | `taxReport()` procedure |
| MyTax data | `src/server/services/transaction/mytax.ts` | `buildMyTaxReport()` |
| CGT data | `src/server/services/tax/cgt.ts` | `calculateCapitalGain()` |
| Tax position | `src/server/services/tax/position.ts` | `calculateTaxPosition()` |
| Portfolio data | Reports router | `portfolioSummary()` |
| Invite system | `portfolioInvites` + `portfolioMembers` | Accountant role already in enum |
| FY selector | `reports.getAvailableYears()` | Available years dropdown |

## Security

- All mutations use `writeProcedure` (checks `canWrite`)
- Queries scoped by `ctx.portfolio.ownerId`
- Accountant email only sent to verified portfolio member
- PDF generated server-side, no client-side data exposure
- Resend handles email delivery security (DKIM, SPF)
- Send history tracks all deliveries for audit

## Out of Scope (v2)

- Accountant portal (read-only login for accountants)
- Excel/CSV export alongside PDF
- Scheduled automatic sends (e.g., auto-send after EOFY)
- Multiple accountant support
- Custom branding on PDF
